<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ElectricPatterns — NILM Pipeline</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: #FAFBFF;
            color: #3D3D50;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Hero */
        header {
            background: linear-gradient(135deg, #7B9BC4 0%, #B488B4 100%);
            color: white;
            padding: 50px 30px;
            margin-bottom: 30px;
            border-radius: 16px;
            text-align: center;
        }

        header h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            letter-spacing: -0.5px;
            font-weight: 700;
        }

        header .subtitle {
            font-size: 1.2em;
            opacity: 0.92;
            margin-bottom: 8px;
        }

        header .description {
            font-size: 0.95em;
            opacity: 0.75;
            max-width: 700px;
            margin: 0 auto;
        }

        /* Navigation cards */
        .nav-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
            margin-bottom: 35px;
        }

        .nav-card {
            background: #FFFFFF;
            border-radius: 16px;
            padding: 35px 30px;
            text-align: center;
            box-shadow: 0 2px 12px rgba(120,100,160,0.07);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            text-decoration: none;
            color: inherit;
            display: block;
            border: 1.5px solid #E8E4F0;
        }

        .nav-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(120,100,160,0.12);
        }

        .nav-card.experiment { border-color: #B8E6C8; }
        .nav-card.experiment:hover { background: linear-gradient(135deg, #FFF 0%, #E8F8EE 100%); }
        .nav-card.house { border-color: #A8D8EA; }
        .nav-card.house:hover { background: linear-gradient(135deg, #FFF 0%, #E8F2FA 100%); }
        .nav-card.comparison { border-color: #D4B8E8; }
        .nav-card.comparison:hover { background: linear-gradient(135deg, #FFF 0%, #F0E8F8 100%); }
        .nav-card.identification { border-color: #FFCBA4; }
        .nav-card.identification:hover { background: linear-gradient(135deg, #FFF 0%, #FFF5EC 100%); }

        .nav-card .card-icon { font-size: 2.5em; margin-bottom: 12px; }
        .nav-card h2 { font-size: 1.4em; margin-bottom: 8px; color: #3D3D50; }
        .nav-card p { color: #7D7D92; font-size: 0.92em; }

        /* Table of contents */
        .toc {
            background: #FFFFFF;
            border-radius: 14px;
            padding: 28px 32px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(120,100,160,0.06);
        }

        .toc h2 {
            color: #3D3D50;
            font-size: 1.15em;
            margin-bottom: 18px;
            padding-bottom: 10px;
            border-bottom: 2px solid #E8E4F0;
        }

        .toc-columns {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .toc-group { display: flex; flex-direction: column; gap: 4px; }

        .toc-group-header {
            font-size: 0.72em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            padding: 5px 10px;
            border-radius: 6px;
            margin-bottom: 4px;
        }

        .toc-group a {
            color: #5D5D72;
            text-decoration: none;
            font-size: 0.85em;
            padding: 4px 10px;
            border-radius: 6px;
            transition: background 0.15s, color 0.15s;
            display: block;
        }

        .toc-group a:hover { background: #7B9BC4; color: white; }

        @media (max-width: 900px) { .toc-columns { grid-template-columns: 1fr 1fr; } }
        @media (max-width: 560px) { .toc-columns { grid-template-columns: 1fr; } }

        /* Sections */
        section {
            background: #FFFFFF;
            border-radius: 14px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(120,100,160,0.06);
            border-left: 4px solid transparent;
        }

        section.m1-section { border-left-color: #A8D8EA; }
        section.postm1-section { border-left-color: #FFCBA4; }
        section.m2-section { border-left-color: #B8E6C8; }

        section h2 {
            color: #3D3D50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #E8E4F0;
            font-size: 1.5em;
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 30px;
        }

        section h2::after {
            content: '\25BE';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-60%);
            font-size: 0.7em;
            color: #C0BCD0;
            transition: transform 0.3s;
        }

        section.collapsed h2 { margin-bottom: 0; padding-bottom: 10px; border-bottom-color: transparent; }
        section.collapsed h2::after { content: '\25B8'; }
        section .section-body { transition: max-height 0.4s ease; }
        section.collapsed .section-body { display: none; }

        section h3 { color: #4D4D65; margin-bottom: 10px; font-size: 1.1em; }

        /* Pipeline flow */
        .pipeline-flow {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 0;
            margin: 25px 0;
        }

        .pipeline-step {
            background: linear-gradient(135deg, #7888A0, #98A8C0);
            color: white;
            padding: 14px 22px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95em;
            text-align: center;
            min-width: 140px;
        }

        .pipeline-arrow { color: #C0BCD0; font-size: 1.6em; padding: 0 8px; font-weight: bold; }
        .pipeline-desc { text-align: center; color: #7D7D92; margin-top: 15px; font-size: 0.9em; }

        /* Sub-pipeline detail */
        .sub-pipeline {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 4px;
            padding: 10px 16px;
            background: #F5F4FA;
            border-radius: 10px;
            border: 1px solid #E8E4F0;
            margin-top: 12px;
        }

        .sub-step { font-size: 0.8em; padding: 4px 10px; border-radius: 6px; font-weight: 500; }
        .sub-arrow { color: #C8C4D4; font-size: 0.9em; }

        /* Event cards grid */
        .event-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 15px;
        }

        .event-card {
            border: 1px solid #E8E4F0;
            border-radius: 14px;
            padding: 20px;
            background: #FAFBFF;
        }

        .event-card h3 { display: flex; align-items: center; gap: 8px; }

        .event-card .badge {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .badge-on { background: #D8F0E0; color: #3A6A4A; }
        .badge-off { background: #F5D8D8; color: #6A3030; }
        .badge-clean { background: #D0E4F4; color: #2A5A7A; }
        .badge-noisy { background: #F5ECD5; color: #6A5A2A; }
        .badge-partial { background: #E5D8F0; color: #5A3A7A; }
        .badge-refine { background: #D0ECF8; color: #2A6A82; }
        .badge-validate { background: #F8EAD8; color: #6A4A20; }
        .badge-seg { background: #D5E4F5; color: #2A4A70; }

        .event-card p { color: #5D5D72; font-size: 0.88em; margin-top: 8px; }
        .event-card svg { display: block; margin: 12px auto 0; width: 100%; max-width: 380px; }

        /* Match grid */
        .match-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 15px; }

        /* Device grid */
        .device-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 15px; }

        .device-card {
            border: 1px solid #E8E4F0;
            border-radius: 14px;
            padding: 20px;
            background: #FAFBFF;
            text-align: center;
        }

        .device-card svg { display: block; margin: 12px auto 0; width: 100%; max-width: 320px; }
        .device-card p { color: #5D5D72; font-size: 0.88em; margin-top: 8px; }

        /* Tags section */
        .tags-table { width: 100%; border-collapse: collapse; font-size: 0.9em; margin-top: 10px; }

        .tags-table th {
            background: #7888A0;
            color: white;
            padding: 10px 14px;
            text-align: left;
        }

        .tags-table th:first-child { border-radius: 8px 0 0 0; }
        .tags-table th:last-child { border-radius: 0 8px 0 0; }
        .tags-table td { padding: 10px 14px; border-bottom: 1px solid #E8E4F0; }
        .tags-table tr:hover { background: #F5F4FA; }

        .tag-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.85em;
            font-weight: 600;
        }

        /* Segmentation paths */
        .seg-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 15px; }

        /* Validation cards */
        .validation-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 15px; }

        .validation-card {
            border: 1px solid #E8E4F0;
            border-radius: 14px;
            padding: 18px;
            background: #FAFBFF;
        }

        .validation-card h3 { font-size: 1em; margin-bottom: 8px; }
        .validation-card p { color: #5D5D72; font-size: 0.85em; }

        .validation-card .threshold {
            display: inline-block;
            margin-top: 8px;
            padding: 3px 10px;
            background: #F0EEF6;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.82em;
            color: #5D5D72;
        }

        /* Module dividers */
        .module-banner {
            background: linear-gradient(135deg, #7888A0, #98A8C0);
            color: white;
            padding: 22px 30px;
            border-radius: 14px;
            margin-top: 35px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 18px;
        }

        .module-banner.module1 { background: linear-gradient(135deg, #5A90C0 0%, #A8D8EA 100%); }
        .module-banner.module2 { background: linear-gradient(135deg, #5EB88A 0%, #B8E6C8 100%); }
        .module-banner.post-m1 { background: linear-gradient(135deg, #D4956A 0%, #FFCBA4 100%); }

        .module-banner .module-number {
            font-size: 2.2em;
            font-weight: 800;
            opacity: 0.35;
            line-height: 1;
            white-space: nowrap;
        }

        .module-banner .module-info h2 {
            font-size: 1.3em;
            margin-bottom: 4px;
            border: none;
            padding: 0;
            color: white;
            cursor: default;
        }

        .module-banner .module-info h2::after { display: none; }
        .module-banner .module-info p { font-size: 0.88em; opacity: 0.85; }

        /* Research context */
        .research-context {
            background: #FFFFFF;
            border-radius: 14px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(120,100,160,0.06);
            border-left: 4px solid #A8D8EA;
        }

        .research-context h2 { color: #3D3D50; margin-bottom: 15px; font-size: 1.3em; }
        .research-context p { color: #5D5D72; font-size: 0.92em; margin-bottom: 10px; }

        .device-scope { display: flex; gap: 20px; margin-top: 15px; }

        .scope-card {
            flex: 1;
            padding: 18px;
            border-radius: 12px;
            border: 1px solid #E8E4F0;
        }

        .scope-card.in-scope { background: #EEF8F0; border-color: #C0E0C8; }
        .scope-card.out-scope { background: #FFF0F0; border-color: #F0D0D0; }
        .scope-card h3 { font-size: 0.95em; margin-bottom: 6px; }
        .scope-card p { font-size: 0.82em; color: #7D7D92; }
        .scope-card ul { list-style: none; padding: 0; margin: 8px 0 0; font-size: 0.85em; }
        .scope-card ul li { padding: 2px 0; color: #5D5D72; }

        /* Architecture flow */
        .arch-flow {
            background: #FFFFFF;
            border-radius: 14px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(120,100,160,0.06);
        }

        .arch-flow h2 {
            color: #3D3D50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #E8E4F0;
            font-size: 1.3em;
        }

        @media (max-width: 768px) {
            .device-scope { flex-direction: column; }
            .module-banner { flex-direction: column; text-align: center; }
        }

        /* Comparison overlay */
        .comparison-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 1000;
            background: #FAFBFF;
            flex-direction: column;
        }

        .comparison-overlay.active { display: flex; }

        .comparison-toolbar {
            background: #7B9BC4;
            color: white;
            padding: 8px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
        }

        .comparison-toolbar h2 {
            font-size: 1.1em; font-weight: 600; margin: 0;
            border: none; padding: 0; color: white;
        }

        .comparison-close {
            background: #D47070;
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            margin-left: auto;
        }

        .comparison-close:hover { background: #C06060; }

        .comparison-labels { display: flex; flex-shrink: 0; }
        .comparison-labels div { flex: 1; text-align: center; padding: 6px; font-weight: 600; font-size: 0.85em; }
        .comparison-labels .label-original { background: #E8E4F0; color: #3D3D50; }
        .comparison-labels .label-nan { background: #D8F0E0; color: #3A6A4A; }

        .comparison-frames { display: flex; flex: 1; min-height: 0; gap: 2px; }
        .comparison-frames iframe { flex: 1; border: none; }

        /* Footer */
        footer { text-align: center; padding: 25px; color: #B0B0C0; font-size: 0.85em; }
        footer a { color: #7B9BC4; text-decoration: none; }
        footer a:hover { text-decoration: underline; }

        /* Responsive */
        @media (max-width: 768px) {
            header h1 { font-size: 2em; }
            .nav-grid { grid-template-columns: 1fr !important; }
            .event-grid, .match-grid, .device-grid, .seg-grid, .validation-grid { grid-template-columns: 1fr; }
            .pipeline-flow { flex-direction: column; }
            .pipeline-arrow { transform: rotate(90deg); }
            .sub-pipeline { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>
    <div class="container">

        <!-- Hero -->
        <header>
            <h1>ElectricPatterns</h1>
            <div class="subtitle">Non-Intrusive Load Monitoring (NILM) Pipeline</div>
            <div class="description">
                Detecting and classifying household device usage from aggregate 3-phase power data.
                The pipeline identifies ON/OFF events, matches them into device activations, and segregates
                total consumption into device-specific and background power.
            </div>
        </header>

        <!-- Research Context -->
        <div class="research-context" id="context">
            <h2>Research Scope</h2>
            <p>
                This project focuses on <strong>high-power deterministic devices</strong> — appliances with
                predictable, rule-based power signatures. These devices draw significant power (800W+),
                exhibit clear ON/OFF transitions, and maintain relatively stable consumption during operation.
                This makes them separable from aggregate power data using signal processing and heuristic rules,
                without requiring machine learning models.
            </p>
            <p>
                Devices with complex, non-deterministic operating cycles (washing machines, dishwashers, dryers)
                involve multiple internal states (fill, heat, agitate, drain, spin) that produce irregular power
                profiles. These cannot be decomposed into simple ON/OFF rules and are outside the scope of this work.
            </p>
            <div class="device-scope">
                <div class="scope-card in-scope">
                    <h3 style="color:#3A6A4A;">In scope — deterministic patterns</h3>
                    <ul>
                        <li><strong>Boiler / water heater</strong> — flat block, single phase, 2000-3000W, 15-45 min</li>
                        <li><strong>Regular AC (split)</strong> — compressor cycling, single phase, 800-1500W per cycle</li>
                        <li><strong>Central AC (ducted)</strong> — synchronized events across 2-3 phases</li>
                    </ul>
                </div>
                <div class="scope-card out-scope">
                    <h3 style="color:#C07070;">Out of scope — complex cycles</h3>
                    <ul>
                        <li><strong>Washing machine</strong> — fill, heat, wash, rinse, spin (variable power profile)</li>
                        <li><strong>Dishwasher</strong> — multi-stage wash with heating elements and pumps</li>
                        <li><strong>Dryer</strong> — heating cycles with moisture-dependent duration</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- High-Level Architecture -->
        <div class="arch-flow" id="architecture">
            <h2>Pipeline Architecture</h2>
            <svg viewBox="0 0 980 310" xmlns="http://www.w3.org/2000/svg" style="width:100%; display:block;">
                <!-- ====== Raw Data input ====== -->
                <rect x="10" y="130" width="90" height="50" rx="8" fill="#E8E4F0" stroke="#B0B4D0" stroke-width="1.5"/>
                <text x="55" y="152" fill="#3D3D50" font-size="10" font-weight="bold" text-anchor="middle">Raw Data</text>
                <text x="55" y="166" fill="#7D7D92" font-size="7.5" text-anchor="middle">3-phase power</text>

                <!-- Arrow to Segmentator -->
                <line x1="102" y1="155" x2="128" y2="155" stroke="#B0B4D0" stroke-width="2"/>
                <polygon points="128,150 138,155 128,160" fill="#B0B4D0"/>

                <!-- ====== SEGMENTATOR — outer box ====== -->
                <rect x="140" y="10" width="530" height="290" rx="14" fill="#F8F9FF" stroke="#5A90C0" stroke-width="2.5"/>
                <rect x="140" y="10" width="530" height="34" rx="14" fill="#5A90C0"/>
                <rect x="140" y="30" width="530" height="14" fill="#5A90C0"/>
                <text x="405" y="34" fill="white" font-size="14" font-weight="bold" text-anchor="middle">Segmentator</text>

                <!-- ---- Rectangle sub-box ---- -->
                <rect x="158" y="55" width="220" height="185" rx="10" fill="#EEF4FF" stroke="#A8D8EA" stroke-width="1.5"/>
                <rect x="158" y="55" width="220" height="26" rx="10" fill="#7BB8E0"/>
                <rect x="158" y="68" width="220" height="13" fill="#7BB8E0"/>
                <text x="268" y="73" fill="white" font-size="11" font-weight="bold" text-anchor="middle">Rectangles</text>

                <!-- Rectangle steps -->
                <rect x="178" y="90" width="90" height="28" rx="5" fill="#fff" stroke="#C0D8F0" stroke-width="1"/>
                <text x="223" y="108" fill="#4A7AA0" font-size="9" font-weight="600" text-anchor="middle">Detection</text>

                <line x1="223" y1="118" x2="223" y2="128" stroke="#A8D8EA" stroke-width="1.2"/>
                <polygon points="220,127 223,131 226,127" fill="#A8D8EA"/>

                <rect x="178" y="131" width="90" height="28" rx="5" fill="#fff" stroke="#C0D8F0" stroke-width="1"/>
                <text x="223" y="149" fill="#4A7AA0" font-size="9" font-weight="600" text-anchor="middle">Matching</text>

                <line x1="223" y1="159" x2="223" y2="169" stroke="#A8D8EA" stroke-width="1.2"/>
                <polygon points="220,168 223,172 226,168" fill="#A8D8EA"/>

                <rect x="178" y="172" width="90" height="28" rx="5" fill="#fff" stroke="#C0D8F0" stroke-width="1"/>
                <text x="223" y="190" fill="#4A7AA0" font-size="9" font-weight="600" text-anchor="middle">Segmentation</text>

                <!-- Rectangle: ON ≈ OFF label -->
                <text x="315" y="108" fill="#7D7D92" font-size="7" text-anchor="middle">sharp/gradual</text>
                <text x="315" y="119" fill="#7D7D92" font-size="7" text-anchor="middle">ON &asymp; OFF</text>

                <!-- Iterative loop -->
                <path d="M 267,194 C 267,215 177,215 177,188" fill="none" stroke="#5A90C0" stroke-width="1.2" stroke-dasharray="4,3"/>
                <polygon points="175,192 177,184 180,191" fill="#5A90C0"/>
                <text x="222" y="228" fill="#5A90C0" font-size="7" text-anchor="middle">4 thresholds (2000&rarr;800W)</text>

                <!-- ---- Wave sub-box ---- -->
                <rect x="395" y="55" width="220" height="185" rx="10" fill="#FFF5EC" stroke="#E8C09A" stroke-width="1.5"/>
                <rect x="395" y="55" width="220" height="26" rx="10" fill="#D4956A"/>
                <rect x="395" y="68" width="220" height="13" fill="#D4956A"/>
                <text x="505" y="73" fill="white" font-size="11" font-weight="bold" text-anchor="middle">Waves</text>

                <!-- Wave steps -->
                <rect x="415" y="90" width="130" height="28" rx="5" fill="#fff" stroke="#E8D4B0" stroke-width="1"/>
                <text x="480" y="108" fill="#7A5030" font-size="9" font-weight="600" text-anchor="middle">Detect wave patterns</text>

                <line x1="480" y1="118" x2="480" y2="128" stroke="#E8D4B0" stroke-width="1.2"/>
                <polygon points="477,127 480,131 483,127" fill="#E8D4B0"/>

                <rect x="415" y="131" width="130" height="28" rx="5" fill="#fff" stroke="#E8D4B0" stroke-width="1"/>
                <text x="480" y="149" fill="#7A5030" font-size="9" font-weight="600" text-anchor="middle">Cross-phase search</text>

                <line x1="480" y1="159" x2="480" y2="169" stroke="#E8D4B0" stroke-width="1.2"/>
                <polygon points="477,168 480,172 483,168" fill="#E8D4B0"/>

                <rect x="415" y="172" width="130" height="28" rx="5" fill="#fff" stroke="#E8D4B0" stroke-width="1"/>
                <text x="480" y="190" fill="#7A5030" font-size="9" font-weight="600" text-anchor="middle">Extract wave power</text>

                <!-- Wave: ON >> OFF label -->
                <text x="570" y="108" fill="#7D7D92" font-size="7" text-anchor="middle">sharp rise &rarr;</text>
                <text x="570" y="119" fill="#7D7D92" font-size="7" text-anchor="middle">gradual decay</text>

                <!-- runs once label -->
                <text x="505" y="228" fill="#D4956A" font-size="7" text-anchor="middle">runs once on remaining</text>

                <!-- ---- Internal arrow: Rectangles → remaining → Waves ---- -->
                <line x1="378" y1="155" x2="395" y2="155" stroke="#B0B4D0" stroke-width="1.5" stroke-dasharray="4,2"/>
                <text x="387" y="148" fill="#7D7D92" font-size="6" text-anchor="middle">remaining</text>

                <!-- ---- Shared output: duration categories ---- -->
                <rect x="220" y="252" width="120" height="28" rx="6" fill="#D0ECD8" stroke="#5EB88A" stroke-width="1"/>
                <text x="280" y="270" fill="#3A6A4A" font-size="8.5" font-weight="600" text-anchor="middle">Short (&le;2 min)</text>

                <rect x="355" y="252" width="120" height="28" rx="6" fill="#F8F0D0" stroke="#D4B870" stroke-width="1"/>
                <text x="415" y="270" fill="#6A5A2A" font-size="8.5" font-weight="600" text-anchor="middle">Medium (3-24 min)</text>

                <rect x="490" y="252" width="120" height="28" rx="6" fill="#F5D8D8" stroke="#D47070" stroke-width="1"/>
                <text x="550" y="270" fill="#C07070" font-size="8.5" font-weight="600" text-anchor="middle">Long (&ge;25 min)</text>

                <text x="405" y="298" fill="#7D7D92" font-size="7.5" text-anchor="middle">matched ON/OFF pairs &mdash; tagged by source (EXACT-*, WAVE-*)</text>

                <!-- ====== Arrow: Segmentator → Identifier ====== -->
                <line x1="672" y1="155" x2="698" y2="155" stroke="#B0B4D0" stroke-width="2"/>
                <polygon points="698,150 708,155 698,160" fill="#B0B4D0"/>
                <text x="690" y="140" fill="#7D7D92" font-size="7" text-anchor="middle">all matches</text>

                <!-- ====== IDENTIFIER box ====== -->
                <rect x="710" y="40" width="200" height="230" rx="14" fill="#EEF8F0" stroke="#5EB88A" stroke-width="2.5"/>
                <rect x="710" y="40" width="200" height="34" rx="14" fill="#5EB88A"/>
                <rect x="710" y="58" width="200" height="16" fill="#5EB88A"/>
                <text x="810" y="62" fill="white" font-size="14" font-weight="bold" text-anchor="middle">Identifier</text>

                <!-- Identifier steps -->
                <rect x="728" y="85" width="164" height="26" rx="5" fill="#fff" stroke="#D0ECD8" stroke-width="1"/>
                <text x="810" y="102" fill="#3A6A4A" font-size="9" font-weight="600" text-anchor="middle">Spike Filter (&lt;3 min)</text>

                <line x1="810" y1="111" x2="810" y2="119" stroke="#A8D8C0" stroke-width="1.2"/>
                <polygon points="807,118 810,122 813,118" fill="#A8D8C0"/>

                <rect x="728" y="122" width="164" height="26" rx="5" fill="#fff" stroke="#D0ECD8" stroke-width="1"/>
                <text x="810" y="139" fill="#3A6A4A" font-size="9" font-weight="600" text-anchor="middle">Classify-First Pipeline</text>

                <line x1="810" y1="148" x2="810" y2="156" stroke="#A8D8C0" stroke-width="1.2"/>
                <polygon points="807,155 810,159 813,155" fill="#A8D8C0"/>

                <rect x="728" y="159" width="164" height="26" rx="5" fill="#fff" stroke="#D0ECD8" stroke-width="1"/>
                <text x="810" y="176" fill="#3A6A4A" font-size="9" font-weight="600" text-anchor="middle">Boiler &rarr; 3-Phase &rarr; AC</text>

                <line x1="810" y1="185" x2="810" y2="193" stroke="#A8D8C0" stroke-width="1.2"/>
                <polygon points="807,192 810,196 813,192" fill="#A8D8C0"/>

                <rect x="728" y="196" width="164" height="26" rx="5" fill="#fff" stroke="#D0ECD8" stroke-width="1"/>
                <text x="810" y="213" fill="#3A6A4A" font-size="9" font-weight="600" text-anchor="middle">Confidence Scoring</text>

                <text x="810" y="240" fill="#7D7D92" font-size="7.5" text-anchor="middle">boiler &bull; 3-phase &bull; central AC &bull; regular AC</text>
                <text x="810" y="251" fill="#7D7D92" font-size="7" text-anchor="middle">rules only &mdash; no ML</text>

                <!-- ====== Arrow: Identifier → Output ====== -->
                <line x1="912" y1="155" x2="930" y2="155" stroke="#B0B4D0" stroke-width="2"/>
                <polygon points="930,150 940,155 930,160" fill="#B0B4D0"/>

                <!-- ====== Final output ====== -->
                <rect x="942" y="105" width="35" height="100" rx="8" fill="#fff" stroke="#E8E4F0" stroke-width="1.5"/>
                <text x="959" y="133" fill="#D47070" font-size="16" text-anchor="middle">&#127777;</text>
                <text x="959" y="147" fill="#3D3D50" font-size="7" font-weight="bold" text-anchor="middle">Boiler</text>
                <text x="959" y="165" fill="#5A90C0" font-size="16" text-anchor="middle">&#10052;</text>
                <text x="959" y="179" fill="#3D3D50" font-size="7" font-weight="bold" text-anchor="middle">AC</text>
                <text x="959" y="196" fill="#7D7D92" font-size="6" text-anchor="middle">per device</text>
            </svg>
        </div>

        <!-- Report Navigation -->
        <div class="nav-grid">
            <a class="nav-card house" href="house_report.html">
                <div class="card-icon">&#127968;</div>
                <h2>Input &mdash; Data Quality</h2>
                <p><strong>Raw data quality</strong> &mdash; coverage, phase health, power patterns, and quality scoring for each household before processing.</p>
            </a>
            <div class="nav-card comparison" onclick="openComparison()" style="cursor:pointer;">
                <div class="card-icon">&#9878;</div>
                <h2>Segmentator Output &mdash; Disaggregation</h2>
                <p><strong>Power decomposition</strong> &mdash; explained vs background vs unmatched power, detection efficiency, threshold contribution.</p>
            </div>
            <a class="nav-card identification" href="identification_report.html">
                <div class="card-icon">&#128268;</div>
                <h2>Identifier Output &mdash; Device Classification</h2>
                <p><strong>Device classification</strong> &mdash; session grouping, boiler/AC detection, confidence scoring, temporal patterns.</p>
            </a>
        </div>

        <!-- Table of Contents -->
        <nav class="toc">
            <h2>Contents</h2>
            <div class="toc-columns">
                <!-- Column 1: Overview + Segmentator Rectangles -->
                <div class="toc-group">
                    <div class="toc-group-header" style="background:#D0E4F4;color:#3A6A9A;">Overview</div>
                    <a href="#context">Research Scope</a>
                    <a href="#architecture">Architecture</a>
                    <div class="toc-group-header" style="background:#D0E4F4;color:#3A6A9A; margin-top:10px;">Segmentator &mdash; Rectangles</div>
                    <a href="#pipeline">Rectangle Pipeline</a>
                    <a href="#detection">Detection</a>
                    <a href="#matching">Matching</a>
                    <a href="#segmentation">Segmentation</a>
                </div>

                <!-- Column 2: Segmentator Waves -->
                <div class="toc-group">
                    <div class="toc-group-header" style="background:#FFE8D0;color:#8A5A30;">Segmentator &mdash; Waves</div>
                    <a href="#wave-recovery">Wave Recovery Pipeline</a>
                    <a href="#wave-detection">Wave Detection Algorithm</a>
                    <a href="#cross-phase">Cross-Phase Search</a>
                    <a href="#wave-extraction">Wave Power Extraction</a>
                    <a href="#hole-repair">Hole Repair</a>
                </div>

                <!-- Column 3: Identifier -->
                <div class="toc-group">
                    <div class="toc-group-header" style="background:#D8F0E0;color:#3A6A4A;">Identifier</div>
                    <a href="#identifier-pipeline">Identifier Pipeline</a>
                    <a href="#spike-filter">Spike Filter</a>
                    <a href="#classification">Classification</a>
                    <a href="#confidence">Confidence Scoring</a>
                </div>

                <!-- Column 4: Research -->
                <div class="toc-group">
                    <div class="toc-group-header" style="background:#E5D8F0;color:#6A50A0;">Research</div>
                    <a href="#future-directions">Future Directions</a>
                </div>
            </div>
        </nav>

        <!-- ═══════════════════════════════════════════════════════ -->
        <!-- SEGMENTATOR: Rectangles                                -->
        <!-- ═══════════════════════════════════════════════════════ -->
        <div class="module-banner module1">
            <div class="module-number" style="font-size:1.5em;">SEG</div>
            <div class="module-info">
                <h2>Segmentator &mdash; Rectangle Matching</h2>
                <p>The rectangle sub-module of the Segmentator. Detects sharp/gradual ON/OFF events, matches them into pairs, and extracts device power as flat (rectangular) blocks. Iterates across 4 threshold levels (2000&rarr;800W), peeling off progressively smaller devices from the aggregate signal.</p>
            </div>
        </div>

        <!-- Pipeline Overview -->
        <section id="pipeline" class="m1-section">
            <h2>Rectangle Pipeline</h2>
            <p style="color:#7D7D92; margin-bottom:15px;">
                Each iteration runs the full rectangle detection/matching/segmentation pipeline on one threshold level.
                The remaining power after each iteration feeds back as input to the next, revealing progressively smaller devices.
            </p>
            <div class="pipeline-flow">
                <div class="pipeline-step">Detection</div>
                <span class="pipeline-arrow">&#10132;</span>
                <div class="pipeline-step">Matching</div>
                <span class="pipeline-arrow">&#10132;</span>
                <div class="pipeline-step">Segmentation</div>
            </div>

            <!-- Detailed sub-steps -->
            <!-- Sub-pipeline: grouped by stage with headers -->
            <div style="margin-top:12px; display:flex; flex-direction:column; gap:8px;">
                <!-- Detection -->
                <div class="sub-pipeline" style="border-color:#C0D8F0;">
                    <span style="font-size:0.72em; font-weight:700; color:#3A6A9A; text-transform:uppercase; letter-spacing:0.05em; margin-right:6px;">Detection</span>
                    <span class="sub-step" style="background:#D8F0E0;color:#3A6A4A;">Sharp</span>
                    <span class="sub-arrow">&#8594;</span>
                    <span class="sub-step" style="background:#D8F0E0;color:#3A6A4A;">Gradual</span>
                    <span class="sub-arrow">&#8594;</span>
                    <span class="sub-step" style="background:#D0E4F4;color:#2A5A7A;">Expand</span>
                    <span class="sub-arrow">&#8594;</span>
                    <span class="sub-step" style="background:#D0E4F4;color:#2A5A7A;">Merge</span>
                    <span class="sub-arrow">&#8594;</span>
                    <span class="sub-step" style="background:#D0E4F4;color:#2A5A7A;">Near-TH</span>
                    <span class="sub-arrow">&#8594;</span>
                    <span class="sub-step" style="background:#D0E4F4;color:#2A5A7A;">Tail Ext.</span>
                    <span class="sub-arrow">&#8594;</span>
                    <span class="sub-step" style="background:#F5ECD5;color:#6A5A2A;">Split-OFF</span>
                    <span class="sub-arrow">&#8594;</span>
                    <span class="sub-step" style="background:#F5ECD5;color:#6A5A2A;">Settling</span>
                </div>
                <!-- Matching -->
                <div class="sub-pipeline" style="border-color:#E5D8F0;">
                    <span style="font-size:0.72em; font-weight:700; color:#6A50A0; text-transform:uppercase; letter-spacing:0.05em; margin-right:6px;">Matching</span>
                    <span class="sub-step" style="background:#D0E4F4;color:#2A5A7A;">Clean</span>
                    <span class="sub-arrow">&#8594;</span>
                    <span class="sub-step" style="background:#F5ECD5;color:#6A5A2A;">Noisy</span>
                    <span class="sub-arrow">&#8594;</span>
                    <span class="sub-step" style="background:#E5D8F0;color:#6A50A0;">Partial</span>
                    <span class="sub-arrow">&#8594;</span>
                    <span class="sub-step" style="background:#F8EAD8;color:#7A5030;">Validate</span>
                </div>
                <!-- Segmentation -->
                <div class="sub-pipeline" style="border-color:#C0D8F0;">
                    <span style="font-size:0.72em; font-weight:700; color:#3A6A9A; text-transform:uppercase; letter-spacing:0.05em; margin-right:6px;">Segmentation</span>
                    <span class="sub-step" style="background:#D5E4F5;color:#3A6A9A;">Extract Power</span>
                    <span class="sub-arrow">&#8594;</span>
                    <span class="sub-step" style="background:#D5E4F5;color:#3A6A9A;">Clip to Remaining</span>
                    <span class="sub-arrow">&#8594;</span>
                    <span class="sub-step" style="background:#D5E4F5;color:#3A6A9A;">Update Remaining</span>
                </div>
            </div>

            <p class="pipeline-desc">
                Each iteration detects progressively smaller devices by operating on the <em>remaining</em> power
                after removing previously identified devices. Dynamic threshold schedule: 2000W &rarr; 1500W &rarr; 1100W &rarr; 800W.
                First pass catches boilers (2000W+), second reveals ACs hidden underneath, third finds smaller ACs, fourth catches remaining devices.
            </p>

            <!-- Iterative Peeling Illustration -->
            <div style="margin-top:20px;">
                <h3>Iterative Peeling</h3>
                <svg viewBox="0 0 700 180" xmlns="http://www.w3.org/2000/svg" style="width:100%; max-width:700px; display:block; margin:12px auto 0;">
                    <defs>
                        <linearGradient id="gridGrad" x1="0" y1="0" x2="0" y2="1">
                            <stop offset="0%" stop-color="#F0EEF6"/>
                            <stop offset="100%" stop-color="#FAFBFF"/>
                        </linearGradient>
                    </defs>

                    <!-- Iteration 0 (2000W) — detect boiler jump above baseline -->
                    <rect x="5" y="10" width="155" height="130" fill="#F8F9FF" rx="5" stroke="#E8E4F0"/>
                    <text x="82" y="28" fill="#3D3D50" font-size="9" font-weight="bold" text-anchor="middle">Iteration 0 (2000W)</text>
                    <!-- Baseline reference -->
                    <line x1="15" y1="88" x2="150" y2="88" stroke="#8890A0" stroke-width="0.5" stroke-dasharray="3,2"/>
                    <text x="148" y="86" fill="#8890A0" font-size="5" text-anchor="end">baseline</text>
                    <!-- Total signal: baseline with boiler bump on top -->
                    <polyline points="15,88 35,88 40,88 45,30 80,30 110,30 115,88 135,88 150,88"
                              fill="none" stroke="#3D3D50" stroke-width="1.8" stroke-linejoin="round"/>
                    <!-- Boiler: ONLY the jump above baseline, not from zero -->
                    <polygon points="45,30 45,88 115,88 115,30" fill="#D47070" fill-opacity="0.2"/>
                    <text x="80" y="55" fill="#D47070" font-size="7" text-anchor="middle">boiler</text>
                    <text x="80" y="64" fill="#D47070" font-size="5.5" text-anchor="middle">(jump only)</text>

                    <!-- Arrow -->
                    <text x="175" y="82" fill="#B0B4D0" font-size="18" font-weight="bold">&#10132;</text>

                    <!-- Iteration 1 (1500W) — AC compressor cycling visible -->
                    <rect x="195" y="10" width="155" height="130" fill="#F8F9FF" rx="5" stroke="#E8E4F0"/>
                    <text x="272" y="28" fill="#3D3D50" font-size="9" font-weight="bold" text-anchor="middle">Iteration 1 (1500W)</text>
                    <line x1="205" y1="88" x2="340" y2="88" stroke="#8890A0" stroke-width="0.5" stroke-dasharray="3,2"/>
                    <!-- Remaining signal: boiler removed, AC cycling pattern -->
                    <polyline points="205,88 215,88 220,48 240,48 245,88 255,88 260,48 280,48 285,88 295,88 300,48 318,48 323,88 340,88"
                              fill="none" stroke="#3D3D50" stroke-width="1.8" stroke-linejoin="round"/>
                    <!-- Highlight each compressor cycle above baseline -->
                    <polygon points="220,48 220,88 245,88 245,48" fill="#D4956A" fill-opacity="0.18"/>
                    <polygon points="260,48 260,88 285,88 285,48" fill="#D4956A" fill-opacity="0.18"/>
                    <polygon points="300,48 300,88 323,88 323,48" fill="#D4956A" fill-opacity="0.18"/>
                    <text x="272" y="72" fill="#D4956A" font-size="7" text-anchor="middle">AC cycles</text>

                    <!-- Arrow -->
                    <text x="365" y="82" fill="#B0B4D0" font-size="18" font-weight="bold">&#10132;</text>

                    <!-- Iteration 2 (1100W) — smaller device -->
                    <rect x="385" y="10" width="155" height="130" fill="#F8F9FF" rx="5" stroke="#E8E4F0"/>
                    <text x="462" y="28" fill="#3D3D50" font-size="9" font-weight="bold" text-anchor="middle">Iteration 2 (1100W)</text>
                    <line x1="395" y1="88" x2="530" y2="88" stroke="#8890A0" stroke-width="0.5" stroke-dasharray="3,2"/>
                    <!-- Remaining: AC removed, smaller bump visible -->
                    <polyline points="395,88 420,88 430,88 440,58 465,58 475,88 500,88 530,88"
                              fill="none" stroke="#3D3D50" stroke-width="1.8" stroke-linejoin="round"/>
                    <polygon points="440,58 440,88 475,88 475,58" fill="#5A90C0" fill-opacity="0.18"/>
                    <text x="457" y="76" fill="#5A90C0" font-size="7" text-anchor="middle">smaller</text>

                    <!-- Arrow -->
                    <text x="555" y="82" fill="#B0B4D0" font-size="18" font-weight="bold">&#10132;</text>

                    <!-- Final: background -->
                    <rect x="575" y="10" width="115" height="130" fill="#F8F9FF" rx="5" stroke="#E8E4F0"/>
                    <text x="632" y="28" fill="#3D3D50" font-size="9" font-weight="bold" text-anchor="middle">Background</text>
                    <polyline points="585,90 600,87 612,91 625,85 640,89 655,86 670,90 680,88"
                              fill="none" stroke="#8890A0" stroke-width="1.5"/>
                    <text x="632" y="108" fill="#8890A0" font-size="7" text-anchor="middle">unexplained</text>

                    <!-- Bottom label -->
                    <text x="350" y="170" fill="#7D7D92" font-size="9" text-anchor="middle">Each iteration detects only the power jump (event magnitude), not the total power during activation</text>
                </svg>
            </div>
        </section>

        <!-- Event Detection -->
        <section id="detection" class="m1-section">
            <h2>Detection</h2>
            <p style="color:#7D7D92; margin-bottom:15px;">
                The pipeline detects two types of power events on each of the three phases (w1, w2, w3),
                plus a tail extension step that captures residual power decay after OFF events:
            </p>

            <div class="event-grid">
                <!-- Sharp ON -->
                <div class="event-card">
                    <h3><span class="badge badge-on">ON</span> Sharp Event</h3>
                    <p>A single-minute power jump exceeding the threshold. Example: a boiler thermostat clicks on and the heating element instantly draws 2000W, or an AC compressor engages and pulls 1500W — the full load appears within a single data sample.</p>
                    <svg viewBox="0 0 380 140" xmlns="http://www.w3.org/2000/svg">
                        <rect x="40" y="10" width="320" height="110" fill="url(#gridGrad)" rx="4"/>
                        <line x1="40" y1="35" x2="360" y2="35" stroke="#E0DCF0" stroke-dasharray="4"/>
                        <line x1="40" y1="60" x2="360" y2="60" stroke="#E0DCF0" stroke-dasharray="4"/>
                        <line x1="40" y1="85" x2="360" y2="85" stroke="#E0DCF0" stroke-dasharray="4"/>
                        <line x1="40" y1="120" x2="360" y2="120" stroke="#B0B0C0" stroke-width="1"/>
                        <line x1="40" y1="10" x2="40" y2="120" stroke="#B0B0C0" stroke-width="1"/>
                        <text x="15" y="40" fill="#9090A0" font-size="9" text-anchor="middle">2kW</text>
                        <text x="15" y="90" fill="#9090A0" font-size="9" text-anchor="middle">0.5kW</text>
                        <text x="200" y="135" fill="#9090A0" font-size="9" text-anchor="middle">time (minutes)</text>
                        <polyline points="50,95 90,95 130,95 160,95 165,95 170,35 210,35 250,35 290,35 330,35 350,35"
                                  fill="none" stroke="#3D3D50" stroke-width="2.5" stroke-linejoin="round"/>
                        <line x1="155" y1="35" x2="155" y2="95" stroke="#5EB88A" stroke-width="1.5" stroke-dasharray="5,3"/>
                        <text x="148" y="68" fill="#5EB88A" font-size="10" font-weight="bold" text-anchor="end">&ge; TH</text>
                        <polygon points="162,50 168,50 165,40" fill="#5EB88A"/>
                        <polygon points="162,80 168,80 165,90" fill="#5EB88A"/>
                    </svg>
                </div>

                <!-- Sharp OFF -->
                <div class="event-card">
                    <h3><span class="badge badge-off">OFF</span> Sharp Event</h3>
                    <p>A single-minute power drop exceeding the threshold. Example: a boiler reaches its target temperature and the thermostat cuts the heating element — instant drop from 2000W to 0W. Most resistive devices in Israeli households shut off this way.</p>
                    <svg viewBox="0 0 380 140" xmlns="http://www.w3.org/2000/svg">
                        <rect x="40" y="10" width="320" height="110" fill="url(#gridGrad)" rx="4"/>
                        <line x1="40" y1="35" x2="360" y2="35" stroke="#E0DCF0" stroke-dasharray="4"/>
                        <line x1="40" y1="60" x2="360" y2="60" stroke="#E0DCF0" stroke-dasharray="4"/>
                        <line x1="40" y1="85" x2="360" y2="85" stroke="#E0DCF0" stroke-dasharray="4"/>
                        <line x1="40" y1="120" x2="360" y2="120" stroke="#B0B0C0" stroke-width="1"/>
                        <line x1="40" y1="10" x2="40" y2="120" stroke="#B0B0C0" stroke-width="1"/>
                        <text x="15" y="40" fill="#9090A0" font-size="9" text-anchor="middle">2kW</text>
                        <text x="15" y="90" fill="#9090A0" font-size="9" text-anchor="middle">0.5kW</text>
                        <text x="200" y="135" fill="#9090A0" font-size="9" text-anchor="middle">time (minutes)</text>
                        <polyline points="50,35 90,35 130,35 170,35 200,35 205,95 240,95 280,95 320,95 350,95"
                                  fill="none" stroke="#3D3D50" stroke-width="2.5" stroke-linejoin="round"/>
                        <line x1="215" y1="35" x2="215" y2="95" stroke="#D47070" stroke-width="1.5" stroke-dasharray="5,3"/>
                        <text x="222" y="68" fill="#D47070" font-size="10" font-weight="bold">&ge; TH</text>
                        <polygon points="208,50 214,50 211,40" fill="#D47070"/>
                        <polygon points="208,80 214,80 211,90" fill="#D47070"/>
                    </svg>
                </div>

                <!-- Gradual ON -->
                <div class="event-card">
                    <h3><span class="badge badge-on">ON</span> Gradual Event</h3>
                    <p>A multi-minute power ramp where each step is below threshold, but the cumulative increase (over 2-3 min) exceeds it. Example: an inverter AC ramping up its compressor speed — each minute adds 500-700W, reaching full 1500W over 3 minutes. No single step crosses the threshold alone.</p>
                    <svg viewBox="0 0 380 140" xmlns="http://www.w3.org/2000/svg">
                        <rect x="40" y="10" width="320" height="110" fill="url(#gridGrad)" rx="4"/>
                        <line x1="40" y1="35" x2="360" y2="35" stroke="#E0DCF0" stroke-dasharray="4"/>
                        <line x1="40" y1="60" x2="360" y2="60" stroke="#E0DCF0" stroke-dasharray="4"/>
                        <line x1="40" y1="85" x2="360" y2="85" stroke="#E0DCF0" stroke-dasharray="4"/>
                        <line x1="40" y1="120" x2="360" y2="120" stroke="#B0B0C0" stroke-width="1"/>
                        <line x1="40" y1="10" x2="40" y2="120" stroke="#B0B0C0" stroke-width="1"/>
                        <text x="15" y="40" fill="#9090A0" font-size="9" text-anchor="middle">2kW</text>
                        <text x="15" y="90" fill="#9090A0" font-size="9" text-anchor="middle">0.5kW</text>
                        <text x="200" y="135" fill="#9090A0" font-size="9" text-anchor="middle">time (minutes)</text>
                        <polyline points="50,95 90,95 120,95 140,75 170,55 200,35 240,35 280,35 320,35 350,35"
                                  fill="none" stroke="#3D3D50" stroke-width="2.5" stroke-linejoin="round"/>
                        <line x1="120" y1="95" x2="120" y2="75" stroke="#5EB88A" stroke-width="1" stroke-dasharray="3"/>
                        <line x1="140" y1="75" x2="140" y2="55" stroke="#5EB88A" stroke-width="1" stroke-dasharray="3"/>
                        <line x1="170" y1="55" x2="170" y2="35" stroke="#5EB88A" stroke-width="1" stroke-dasharray="3"/>
                        <line x1="110" y1="95" x2="110" y2="35" stroke="#5EB88A" stroke-width="1.5" stroke-dasharray="5,3"/>
                        <text x="102" y="68" fill="#5EB88A" font-size="9" font-weight="bold" text-anchor="end">sum</text>
                        <text x="102" y="78" fill="#5EB88A" font-size="9" font-weight="bold" text-anchor="end">&ge; TH</text>
                    </svg>
                </div>

                <!-- Gradual OFF -->
                <div class="event-card">
                    <h3><span class="badge badge-off">OFF</span> Gradual Event</h3>
                    <p>A multi-minute power decline. Each step is individually below threshold, but the total drop over 2-3 minutes exceeds it. Example: an inverter AC gradually slowing down its compressor as the room approaches target temperature — power drops 400-600W per minute over 3 minutes.</p>
                    <svg viewBox="0 0 380 140" xmlns="http://www.w3.org/2000/svg">
                        <rect x="40" y="10" width="320" height="110" fill="url(#gridGrad)" rx="4"/>
                        <line x1="40" y1="35" x2="360" y2="35" stroke="#E0DCF0" stroke-dasharray="4"/>
                        <line x1="40" y1="60" x2="360" y2="60" stroke="#E0DCF0" stroke-dasharray="4"/>
                        <line x1="40" y1="85" x2="360" y2="85" stroke="#E0DCF0" stroke-dasharray="4"/>
                        <line x1="40" y1="120" x2="360" y2="120" stroke="#B0B0C0" stroke-width="1"/>
                        <line x1="40" y1="10" x2="40" y2="120" stroke="#B0B0C0" stroke-width="1"/>
                        <text x="15" y="40" fill="#9090A0" font-size="9" text-anchor="middle">2kW</text>
                        <text x="15" y="90" fill="#9090A0" font-size="9" text-anchor="middle">0.5kW</text>
                        <text x="200" y="135" fill="#9090A0" font-size="9" text-anchor="middle">time (minutes)</text>
                        <polyline points="50,35 90,35 120,35 150,35 170,55 200,75 230,95 270,95 310,95 350,95"
                                  fill="none" stroke="#3D3D50" stroke-width="2.5" stroke-linejoin="round"/>
                        <line x1="170" y1="35" x2="170" y2="55" stroke="#D47070" stroke-width="1" stroke-dasharray="3"/>
                        <line x1="200" y1="55" x2="200" y2="75" stroke="#D47070" stroke-width="1" stroke-dasharray="3"/>
                        <line x1="230" y1="75" x2="230" y2="95" stroke="#D47070" stroke-width="1" stroke-dasharray="3"/>
                        <line x1="245" y1="35" x2="245" y2="95" stroke="#D47070" stroke-width="1.5" stroke-dasharray="5,3"/>
                        <text x="252" y="68" fill="#D47070" font-size="9" font-weight="bold">sum</text>
                        <text x="252" y="78" fill="#D47070" font-size="9" font-weight="bold">&ge; TH</text>
                    </svg>
                </div>
            </div>

            <!-- Tail Extension -->
            <div style="margin-top:20px;">
                <div class="event-card" style="max-width:100%;">
                    <h3><span class="badge badge-off">OFF</span> Tail Extension</h3>
                    <p>After a sharp OFF drop, some devices leave residual power that decays over several minutes.
                       Common in ducted AC systems: the compressor shuts off sharply, but the indoor blower fan continues running at reduced power for 5-10 minutes.
                       The tail extension captures this decay, increasing the detected OFF magnitude to match the full device power.</p>
                    <svg viewBox="0 0 520 150" xmlns="http://www.w3.org/2000/svg" style="max-width:520px;">
                        <rect x="40" y="10" width="460" height="115" fill="#F8F9FF" rx="4"/>
                        <line x1="40" y1="30" x2="500" y2="30" stroke="#E0DCF0" stroke-dasharray="4"/>
                        <line x1="40" y1="55" x2="500" y2="55" stroke="#E0DCF0" stroke-dasharray="4"/>
                        <line x1="40" y1="80" x2="500" y2="80" stroke="#E0DCF0" stroke-dasharray="4"/>
                        <line x1="40" y1="105" x2="500" y2="105" stroke="#E0DCF0" stroke-dasharray="4"/>
                        <line x1="40" y1="125" x2="500" y2="125" stroke="#B0B0C0" stroke-width="1"/>
                        <line x1="40" y1="10" x2="40" y2="125" stroke="#B0B0C0" stroke-width="1"/>
                        <text x="18" y="35" fill="#9090A0" font-size="8" text-anchor="middle">1.6kW</text>
                        <text x="18" y="85" fill="#9090A0" font-size="8" text-anchor="middle">280W</text>
                        <text x="18" y="120" fill="#9090A0" font-size="8" text-anchor="middle">0W</text>
                        <polyline points="55,110 80,110 90,30 150,30 200,30 220,30"
                                  fill="none" stroke="#3D3D50" stroke-width="2.5" stroke-linejoin="round"/>
                        <polyline points="220,30 225,80"
                                  fill="none" stroke="#D47070" stroke-width="2.5" stroke-linejoin="round"/>
                        <polyline points="225,80 255,75 285,68 315,58 345,48 370,42 395,38 410,35 430,33 450,30 470,28 490,28"
                                  fill="none" stroke="#D4956A" stroke-width="2.5" stroke-linejoin="round" stroke-dasharray="6,3"/>
                        <line x1="230" y1="30" x2="230" y2="80" stroke="#B0B0C0" stroke-width="1.5" stroke-dasharray="4,2"/>
                        <text x="242" y="50" fill="#9090A0" font-size="8">-1300W</text>
                        <text x="242" y="60" fill="#9090A0" font-size="7">(without tail)</text>
                        <line x1="205" y1="30" x2="205" y2="110" stroke="#D47070" stroke-width="1.5" stroke-dasharray="5,3"/>
                        <text x="175" y="65" fill="#D47070" font-size="8" text-anchor="end">-1600W</text>
                        <text x="175" y="75" fill="#D47070" font-size="7" text-anchor="end">(with tail)</text>
                        <line x1="225" y1="135" x2="470" y2="135" stroke="#D4956A" stroke-width="1.5"/>
                        <line x1="225" y1="131" x2="225" y2="139" stroke="#D4956A" stroke-width="1.5"/>
                        <line x1="470" y1="131" x2="470" y2="139" stroke="#D4956A" stroke-width="1.5"/>
                        <text x="347" y="147" fill="#D4956A" font-size="8" text-anchor="middle">tail: residual decay (up to 10 min)</text>
                    </svg>
                    <p style="font-size:0.82em; color:#9090A0; margin-top:6px;">
                        Example: AC turns off &rarr; sharp drop from 1600W to 280W &rarr; 280W decays to ~0W over 8 minutes.
                        Without tail extension the detected magnitude would be only 1300W instead of the full 1600W.
                    </p>
                </div>
            </div>
            <!-- Detection Refinement -->
            <h3 id="refinement" style="margin-top:30px; padding-top:20px; border-top:2px solid #E8E4F0;">Detection Refinement</h3>
            <p style="color:#7D7D92; margin-bottom:15px;">
                After initial sharp/gradual detection, three refinement steps improve event boundaries and remove duplicates:
            </p>

            <div class="match-grid">
                <!-- Expand -->
                <div class="event-card">
                    <h3><span class="badge badge-refine">Expand</span> Edge Absorption</h3>
                    <p>Looks 1 minute before and after each event. If adjacent power changes are in the same direction and within 5% of the event magnitude, they are absorbed into the event. Example: an AC relay closes 1 minute before the compressor engages, drawing a small pre-current (+60W) that belongs to the same activation.</p>
                    <svg viewBox="0 0 320 130" xmlns="http://www.w3.org/2000/svg">
                        <rect x="30" y="10" width="270" height="95" fill="#F8F9FF" rx="4"/>
                        <line x1="30" y1="110" x2="300" y2="110" stroke="#B0B0C0" stroke-width="1"/>
                        <line x1="30" y1="10" x2="30" y2="110" stroke="#B0B0C0" stroke-width="1"/>
                        <!-- Original event (narrow) -->
                        <polyline points="50,90 80,90 100,85 110,85 115,30 160,30 205,30 210,85 220,85 240,90 280,90"
                                  fill="none" stroke="#3D3D50" stroke-width="2.5" stroke-linejoin="round"/>
                        <!-- Small pre-ramp -->
                        <rect x="95" y="78" width="20" height="12" fill="#4A7AA0" fill-opacity="0.15" rx="2"/>
                        <text x="105" y="75" fill="#4A7AA0" font-size="7" text-anchor="middle">+60W</text>
                        <!-- Small post-ramp -->
                        <rect x="206" y="78" width="20" height="12" fill="#4A7AA0" fill-opacity="0.15" rx="2"/>
                        <text x="216" y="75" fill="#4A7AA0" font-size="7" text-anchor="middle">-40W</text>
                        <!-- Expanded boundary arrows -->
                        <line x1="100" y1="100" x2="220" y2="100" stroke="#4A7AA0" stroke-width="1.5" stroke-dasharray="4,2"/>
                        <text x="160" y="125" fill="#4A7AA0" font-size="8" text-anchor="middle">expanded event boundary</text>
                    </svg>
                </div>

                <!-- Merge -->
                <div class="event-card">
                    <h3><span class="badge badge-refine">Merge</span> Consolidation</h3>
                    <p>When sharp detection sees two instantaneous threshold crossings in consecutive minutes with no opposite event between them, they are merged into a single ON (or OFF) event. This captures a single appliance turning on in two rapid stages. Magnitudes are summed from the detected values. Example: an AC relay engages (+800W at min 0), then the compressor reaches full speed (+400W at min 1) — merged into one +1200W ON event that starts the full activation.</p>
                    <svg viewBox="0 0 420 150" xmlns="http://www.w3.org/2000/svg">
                        <rect x="30" y="10" width="370" height="110" fill="#F8F9FF" rx="4"/>
                        <line x1="30" y1="125" x2="400" y2="125" stroke="#B0B0C0" stroke-width="1"/>
                        <line x1="30" y1="10" x2="30" y2="125" stroke="#B0B0C0" stroke-width="1"/>
                        <!-- Grid lines -->
                        <line x1="30" y1="35" x2="400" y2="35" stroke="#E0DCF0" stroke-dasharray="4"/>
                        <line x1="30" y1="65" x2="400" y2="65" stroke="#E0DCF0" stroke-dasharray="4"/>
                        <line x1="30" y1="95" x2="400" y2="95" stroke="#E0DCF0" stroke-dasharray="4"/>
                        <!-- Y-axis labels -->
                        <text x="18" y="38" fill="#9090A0" font-size="7" text-anchor="middle">1.2kW</text>
                        <text x="18" y="68" fill="#9090A0" font-size="7" text-anchor="middle">0.8kW</text>
                        <text x="18" y="110" fill="#9090A0" font-size="7" text-anchor="middle">0</text>

                        <!-- Signal: baseline → two quick jumps → long flat run → OFF → baseline -->
                        <polyline points="40,108 65,108 70,65 75,35 290,35 295,108 370,108 390,108"
                                  fill="none" stroke="#3D3D50" stroke-width="2.5" stroke-linejoin="round"/>

                        <!-- Highlight the two instantaneous jumps (very narrow = 1 min each) -->
                        <rect x="66" y="63" width="8" height="45" fill="#4A7AA0" fill-opacity="0.18" rx="1"/>
                        <rect x="71" y="33" width="8" height="32" fill="#4A7AA0" fill-opacity="0.12" rx="1"/>

                        <!-- Jump labels -->
                        <text x="55" y="82" fill="#4A7AA0" font-size="7" text-anchor="end">+800W</text>
                        <text x="55" y="50" fill="#4A7AA0" font-size="7" text-anchor="end">+400W</text>
                        <!-- Small arrows pointing to jumps -->
                        <line x1="56" y1="80" x2="66" y2="75" stroke="#4A7AA0" stroke-width="0.7"/>
                        <line x1="56" y1="48" x2="71" y2="45" stroke="#4A7AA0" stroke-width="0.7"/>

                        <!-- Merge bracket (only covers the 2 narrow minutes) -->
                        <line x1="66" y1="118" x2="79" y2="118" stroke="#4A7AA0" stroke-width="1.5"/>
                        <line x1="66" y1="115" x2="66" y2="121" stroke="#4A7AA0" stroke-width="1.5"/>
                        <line x1="79" y1="115" x2="79" y2="121" stroke="#4A7AA0" stroke-width="1.5"/>
                        <text x="72" y="130" fill="#4A7AA0" font-size="6" text-anchor="middle">merge</text>
                        <text x="72" y="137" fill="#4A7AA0" font-size="5.5" text-anchor="middle">2 min</text>

                        <!-- Device running period label -->
                        <text x="182" y="28" fill="#9090A0" font-size="7" text-anchor="middle">device running at 1200W</text>

                        <!-- OFF label -->
                        <text x="298" y="75" fill="#D47070" font-size="7">OFF</text>

                        <!-- Full activation bracket -->
                        <line x1="66" y1="145" x2="295" y2="145" stroke="#9090A0" stroke-width="1" stroke-dasharray="3,2"/>
                        <line x1="66" y1="142" x2="66" y2="148" stroke="#9090A0" stroke-width="1"/>
                        <line x1="295" y1="142" x2="295" y2="148" stroke="#9090A0" stroke-width="1"/>
                        <text x="180" y="150" fill="#9090A0" font-size="6" text-anchor="middle">full activation (merge affects only the ON moment)</text>
                    </svg>
                </div>

                <!-- Near-threshold -->
                <div class="event-card">
                    <h3><span class="badge badge-refine">Near-TH</span> Recovery</h3>
                    <p>Catches events that miss the threshold by a small margin. Extends the window by 1-3 minutes to include adjacent changes that push the total over the threshold. Example: with a 1300W threshold, an oven drawing 1280W would be missed — but a small fluctuation in the adjacent minute pushes the total over.</p>
                    <svg viewBox="0 0 320 130" xmlns="http://www.w3.org/2000/svg">
                        <rect x="30" y="10" width="270" height="95" fill="#F8F9FF" rx="4"/>
                        <line x1="30" y1="110" x2="300" y2="110" stroke="#B0B0C0" stroke-width="1"/>
                        <line x1="30" y1="10" x2="30" y2="110" stroke="#B0B0C0" stroke-width="1"/>
                        <!-- Threshold line -->
                        <line x1="30" y1="40" x2="300" y2="40" stroke="#D47070" stroke-width="1" stroke-dasharray="5,3"/>
                        <text x="285" y="37" fill="#D47070" font-size="7">TH</text>
                        <!-- Signal: almost reaches threshold -->
                        <polyline points="50,90 80,90 100,90 110,88 120,45 160,45 200,45 210,88 220,90 250,90 280,90"
                                  fill="none" stroke="#B0B0C0" stroke-width="1.5" stroke-linejoin="round" stroke-dasharray="4,2"/>
                        <!-- With extension: reaches threshold -->
                        <polyline points="50,90 80,90 100,88 110,82 120,38 160,38 200,38 210,82 220,88 250,90 280,90"
                                  fill="none" stroke="#3D3D50" stroke-width="2.5" stroke-linejoin="round"/>
                        <!-- Miss annotation -->
                        <line x1="140" y1="40" x2="140" y2="45" stroke="#D47070" stroke-width="1.5"/>
                        <text x="155" y="55" fill="#D47070" font-size="7">-3W short</text>
                        <!-- Recovery annotation -->
                        <text x="160" y="125" fill="#4A7AA0" font-size="8" text-anchor="middle">extended window recovers the event</text>
                    </svg>
                </div>
            </div>
            <!-- Settling Extension -->
            <h3 id="settling" style="margin-top:30px; padding-top:20px; border-top:2px solid #E8E4F0;">Settling Extension</h3>
            <p style="color:#7D7D92; margin-bottom:15px;">
                Devices like AC compressors draw a brief high-power transient spike when they turn on (or off),
                which settles to steady-state within 1&ndash;5 minutes. Without correction, the spike inflates
                the detected magnitude, causing downstream matching failures and over-extraction in segmentation.
            </p>

            <div class="match-grid">
                <!-- ON Settling -->
                <div class="event-card" style="border-color:#D4956A;">
                    <h3><span class="badge badge-on">ON</span> Transient Spike</h3>
                    <p>An AC compressor turns on with a 3000W transient spike that settles to 1500W after 1&ndash;2 minutes.
                       The algorithm detects the settling drop (&gt;25% reversal of magnitude) in the minutes after
                       the ON event and extends the event boundary through the settling period.</p>
                    <svg viewBox="0 0 400 160" xmlns="http://www.w3.org/2000/svg">
                        <rect x="25" y="10" width="355" height="120" fill="#F8F9FF" rx="4"/>
                        <line x1="25" y1="135" x2="380" y2="135" stroke="#B0B0C0" stroke-width="1"/>
                        <line x1="25" y1="10" x2="25" y2="135" stroke="#B0B0C0" stroke-width="1"/>
                        <!-- Baseline -->
                        <polyline points="35,120 65,120"
                                  fill="none" stroke="#3D3D50" stroke-width="2.5" stroke-linejoin="round"/>
                        <!-- Spike up -->
                        <polyline points="65,120 75,25"
                                  fill="none" stroke="#D47070" stroke-width="2.5" stroke-linejoin="round"/>
                        <!-- Settling -->
                        <polyline points="75,25 95,65 105,70"
                                  fill="none" stroke="#D4956A" stroke-width="2.5" stroke-linejoin="round"/>
                        <!-- Steady state -->
                        <polyline points="105,70 250,70"
                                  fill="none" stroke="#3D3D50" stroke-width="2.5" stroke-linejoin="round"/>
                        <!-- OFF -->
                        <polyline points="250,70 260,120 350,120"
                                  fill="none" stroke="#3D3D50" stroke-width="2.5" stroke-linejoin="round"/>
                        <!-- Original ON boundary -->
                        <line x1="75" y1="15" x2="75" y2="140" stroke="#D47070" stroke-width="1" stroke-dasharray="4,2"/>
                        <text x="78" y="148" fill="#D47070" font-size="7">original end</text>
                        <!-- Extended boundary -->
                        <line x1="105" y1="15" x2="105" y2="140" stroke="#5EB88A" stroke-width="1.5" stroke-dasharray="4,2"/>
                        <text x="108" y="148" fill="#5EB88A" font-size="7">extended end</text>
                        <!-- Labels -->
                        <text x="75" y="20" fill="#D47070" font-size="8">3000W</text>
                        <text x="108" y="63" fill="#5EB88A" font-size="8">1500W</text>
                        <text x="90" y="52" fill="#D4956A" font-size="7">settling</text>
                        <!-- Magnitude annotations -->
                        <text x="200" y="155" fill="#7D7D92" font-size="7" text-anchor="middle">magnitude corrected from 3000W &rarr; 1500W; cumsum tracks steady-state</text>
                    </svg>
                    <p style="font-size:0.82em; color:#9090A0; margin-top:6px;">
                        <strong>Key insight:</strong> By extending the ON boundary through settling, the cumsum-based
                        segmentation naturally tracks the correct steady-state value: cumsum(+3000, -1500) = 1500W.
                        Magnitude is recalculated from actual phase values at the settling endpoint.
                    </p>
                </div>

                <!-- OFF Outgoing Spike -->
                <div class="event-card" style="border-color:#9070B4;">
                    <h3><span class="badge badge-off">OFF</span> Pre-Shutdown Spike</h3>
                    <p>Some devices spike briefly before shutting down (e.g., compressor surge before relay opens).
                       The algorithm detects the power rise (&gt;25% of OFF magnitude) in the minutes before the OFF
                       event and extends the event boundary backward to include the spike.</p>
                    <svg viewBox="0 0 400 160" xmlns="http://www.w3.org/2000/svg">
                        <rect x="25" y="10" width="355" height="120" fill="#F8F9FF" rx="4"/>
                        <line x1="25" y1="135" x2="380" y2="135" stroke="#B0B0C0" stroke-width="1"/>
                        <line x1="25" y1="10" x2="25" y2="135" stroke="#B0B0C0" stroke-width="1"/>
                        <!-- Device running -->
                        <polyline points="35,70 140,70"
                                  fill="none" stroke="#3D3D50" stroke-width="2.5" stroke-linejoin="round"/>
                        <!-- Pre-shutdown spike -->
                        <polyline points="140,70 155,25"
                                  fill="none" stroke="#9070B4" stroke-width="2.5" stroke-linejoin="round"/>
                        <!-- Drop -->
                        <polyline points="155,25 170,120"
                                  fill="none" stroke="#D47070" stroke-width="2.5" stroke-linejoin="round"/>
                        <!-- Baseline after -->
                        <polyline points="170,120 350,120"
                                  fill="none" stroke="#3D3D50" stroke-width="2.5" stroke-linejoin="round"/>
                        <!-- Original OFF boundary -->
                        <line x1="155" y1="15" x2="155" y2="140" stroke="#D47070" stroke-width="1" stroke-dasharray="4,2"/>
                        <text x="158" y="148" fill="#D47070" font-size="7">original start</text>
                        <!-- Extended boundary -->
                        <line x1="140" y1="15" x2="140" y2="140" stroke="#5EB88A" stroke-width="1.5" stroke-dasharray="4,2"/>
                        <text x="110" y="148" fill="#5EB88A" font-size="7">extended start</text>
                        <!-- Labels -->
                        <text x="90" y="63" fill="#3D3D50" font-size="8">1500W</text>
                        <text x="148" y="20" fill="#9070B4" font-size="8">spike</text>
                        <text x="200" y="155" fill="#7D7D92" font-size="7" text-anchor="middle">OFF boundary extended backward; magnitude recalculated from phase values</text>
                    </svg>
                    <p style="font-size:0.82em; color:#9090A0; margin-top:6px;">
                        <strong>Parameters:</strong> settling_factor = 0.75 (triggers when reversal &gt; 25% of magnitude),
                        max_settling_minutes = 5. Safety: never extends into another detected event.
                    </p>
                </div>
            </div>
            <!-- Split-OFF Merger -->
            <h3 id="split-off" style="margin-top:30px; padding-top:20px; border-top:2px solid #E8E4F0;">Split-OFF Merger</h3>
            <p style="color:#7D7D92; margin-bottom:15px;">
                Measurement errors can split a single device shutdown into two smaller drops
                (e.g., boiler 2500W drops to 1200W then to 0W in separate minutes).
                Neither drop alone matches the ON event. This step merges consecutive OFF events
                that represent a single physical shutdown.
            </p>

            <div class="match-grid">
                <div class="event-card" style="border-color:#D47070;">
                    <h3><span class="badge badge-off">Merge</span> Split Shutdown</h3>
                    <p>Two consecutive OFF drops are merged when: the gap between them is &le; 2 minutes,
                       no ON event exists between them, and the power between them remains elevated
                       (device still running between the two drops).</p>
                    <svg viewBox="0 0 440 160" xmlns="http://www.w3.org/2000/svg">
                        <rect x="25" y="10" width="395" height="120" fill="#F8F9FF" rx="4"/>
                        <line x1="25" y1="135" x2="420" y2="135" stroke="#B0B0C0" stroke-width="1"/>
                        <line x1="25" y1="10" x2="25" y2="135" stroke="#B0B0C0" stroke-width="1"/>
                        <!-- Device running at 2500W -->
                        <polyline points="35,35 120,35"
                                  fill="none" stroke="#3D3D50" stroke-width="2.5" stroke-linejoin="round"/>
                        <!-- First drop to ~1200W -->
                        <polyline points="120,35 130,70"
                                  fill="none" stroke="#D47070" stroke-width="2.5" stroke-linejoin="round"/>
                        <!-- Brief elevated period -->
                        <polyline points="130,70 165,70"
                                  fill="none" stroke="#D4956A" stroke-width="2.5" stroke-linejoin="round"/>
                        <!-- Second drop to 0 -->
                        <polyline points="165,70 175,120"
                                  fill="none" stroke="#D47070" stroke-width="2.5" stroke-linejoin="round"/>
                        <!-- Baseline -->
                        <polyline points="175,120 350,120"
                                  fill="none" stroke="#3D3D50" stroke-width="2.5" stroke-linejoin="round"/>
                        <!-- Labels -->
                        <text x="80" y="30" fill="#3D3D50" font-size="8">2500W</text>
                        <text x="135" y="63" fill="#D4956A" font-size="8">1200W</text>
                        <text x="125" y="55" fill="#D47070" font-size="7">-1300W</text>
                        <text x="170" y="100" fill="#D47070" font-size="7">-1200W</text>
                        <!-- Merge bracket -->
                        <line x1="120" y1="140" x2="175" y2="140" stroke="#5EB88A" stroke-width="2"/>
                        <line x1="120" y1="136" x2="120" y2="144" stroke="#5EB88A" stroke-width="2"/>
                        <line x1="175" y1="136" x2="175" y2="144" stroke="#5EB88A" stroke-width="2"/>
                        <text x="147" y="155" fill="#5EB88A" font-size="8" text-anchor="middle">merged: -2500W</text>
                        <!-- Right side: result -->
                        <text x="300" y="35" fill="#9090A0" font-size="8" text-anchor="middle">Result: single OFF event</text>
                        <text x="300" y="48" fill="#9090A0" font-size="7" text-anchor="middle">magnitude = phase[end] - phase[start-1min]</text>
                        <text x="300" y="61" fill="#9090A0" font-size="7" text-anchor="middle">now matches the 2500W ON event</text>
                    </svg>
                    <p style="font-size:0.82em; color:#9090A0; margin-top:6px;">
                        <strong>Safety check:</strong> Power between the two drops must be &ge; 50% of second drop magnitude
                        (device still running). If power dropped to baseline between them, they are from different devices.
                    </p>
                </div>
            </div>
            <!-- Transient Spike Clipping -->
            <h3 id="spike-clipping" style="margin-top:30px; padding-top:20px; border-top:2px solid #E8E4F0;">Transient Spike Clipping</h3>
            <p style="color:#7D7D92; margin-bottom:15px;">
                Even after settling extension extends event boundaries, the cumsum-based extraction may temporarily
                overshoot during transient spikes. A mathematical clipping rule ensures that transient power stays
                in the remaining signal rather than being incorrectly attributed to the device.
            </p>

            <div class="match-grid">
                <!-- ON spike clipping -->
                <div class="event-card" style="border-color:#D4956A;">
                    <h3><span class="badge badge-seg">ON</span> Transient Clipping</h3>
                    <p>During the ON ramp, the cumulative sum may spike significantly above the steady-state level.
                       If the peak exceeds 125% of the steady-state (max of first and last values), the extraction
                       is clipped to the steady-state level. The overshoot stays in remaining.</p>
                    <svg viewBox="0 0 400 150" xmlns="http://www.w3.org/2000/svg">
                        <rect x="25" y="10" width="355" height="115" fill="#F8F9FF" rx="4"/>
                        <line x1="25" y1="130" x2="380" y2="130" stroke="#B0B0C0" stroke-width="1"/>
                        <line x1="25" y1="10" x2="25" y2="130" stroke="#B0B0C0" stroke-width="1"/>
                        <!-- Unclamped cumsum (spike) -->
                        <polyline points="50,130 70,20 90,60 280,60"
                                  fill="none" stroke="#D47070" stroke-width="1.5" stroke-dasharray="4,2"/>
                        <text x="72" y="16" fill="#D47070" font-size="7">spike (2615W)</text>
                        <!-- Clamped extraction -->
                        <polyline points="50,130 70,60 90,60 280,60"
                                  fill="none" stroke="#3A6A9A" stroke-width="2.5" stroke-linejoin="round"/>
                        <polygon points="50,130 70,60 280,60 280,130" fill="#3A6A9A" fill-opacity="0.1"/>
                        <text x="175" y="100" fill="#3A6A9A" font-size="9" text-anchor="middle">extracted = 1921W</text>
                        <!-- Clip level line -->
                        <line x1="40" y1="60" x2="350" y2="60" stroke="#5EB88A" stroke-width="1" stroke-dasharray="5,3"/>
                        <text x="355" y="63" fill="#5EB88A" font-size="7">clip</text>
                        <!-- Spike stays in remaining -->
                        <polygon points="50,130 70,20 70,60 50,130" fill="#D47070" fill-opacity="0.1"/>
                        <text x="45" y="75" fill="#D47070" font-size="7">stays in</text>
                        <text x="45" y="84" fill="#D47070" font-size="7">remaining</text>
                        <!-- Formula -->
                        <text x="200" y="145" fill="#7D7D92" font-size="7" text-anchor="middle">Rule: if peak &gt; max(first, last) &times; 1.25, clip to max(first, last)</text>
                    </svg>
                </div>

                <!-- OFF spike clipping -->
                <div class="event-card" style="border-color:#9070B4;">
                    <h3><span class="badge badge-seg">OFF</span> Shutdown Spike Clipping</h3>
                    <p>During the OFF ramp, a pre-shutdown surge may cause the extraction to temporarily exceed
                       the device&rsquo;s steady-state power. If the OFF segment peaks above 125% of device_power,
                       extraction is clipped to device_power. The surge stays in remaining.</p>
                    <svg viewBox="0 0 400 150" xmlns="http://www.w3.org/2000/svg">
                        <rect x="25" y="10" width="355" height="115" fill="#F8F9FF" rx="4"/>
                        <line x1="25" y1="130" x2="380" y2="130" stroke="#B0B0C0" stroke-width="1"/>
                        <line x1="25" y1="10" x2="25" y2="130" stroke="#B0B0C0" stroke-width="1"/>
                        <!-- Device power level -->
                        <polyline points="50,60 140,60"
                                  fill="none" stroke="#3A6A9A" stroke-width="2.5" stroke-linejoin="round"/>
                        <!-- Unclamped OFF (spike) -->
                        <polyline points="140,60 155,20 170,130"
                                  fill="none" stroke="#D47070" stroke-width="1.5" stroke-dasharray="4,2"/>
                        <text x="158" y="16" fill="#D47070" font-size="7">spike</text>
                        <!-- Clamped OFF ramp -->
                        <polyline points="140,60 155,60 170,130"
                                  fill="none" stroke="#3A6A9A" stroke-width="2.5" stroke-linejoin="round"/>
                        <polygon points="50,60 50,130 170,130 140,60" fill="#3A6A9A" fill-opacity="0.1"/>
                        <!-- Clip level -->
                        <line x1="40" y1="60" x2="180" y2="60" stroke="#5EB88A" stroke-width="1" stroke-dasharray="5,3"/>
                        <text x="183" y="63" fill="#5EB88A" font-size="7">device_power</text>
                        <!-- Spike stays in remaining -->
                        <polygon points="140,60 155,20 155,60" fill="#D47070" fill-opacity="0.15"/>
                        <text x="120" y="40" fill="#D47070" font-size="7">stays in remaining</text>
                        <!-- Formula -->
                        <text x="200" y="145" fill="#7D7D92" font-size="7" text-anchor="middle">Rule: if off_seg.max &gt; device_power &times; 1.25, clip to device_power</text>
                    </svg>
                </div>
            </div>

            <p style="color:#9090A0; font-size:0.85em; margin-top:12px;">
                <strong>Design principle:</strong> These rules are mathematical invariants, not special-case patches.
                They apply to all standard (non-NOISY, non-PARTIAL) events and guarantee that transient spikes are
                never incorrectly attributed to device consumption. Energy conservation holds exactly:
                Original = Segregated + Remaining at every minute.
            </p>
            <!-- Guided Cycle Recovery -->
            <h3 id="guided-recovery" style="margin-top:30px; padding-top:20px; border-top:2px solid #E8E4F0;">Guided Cycle Recovery</h3>
            <p style="color:#7D7D92; margin-bottom:15px;">
                After all 4 rectangle iterations complete, a recovery pass searches for missed AC compressor cycles
                using matched cycles as templates. This addresses cycles that fell below the lowest threshold (800W)
                due to interference or partial prior extraction.
            </p>

            <div class="match-grid">
                <div class="event-card" style="border-color:#5EB88A;">
                    <h3><span class="badge badge-on">Recovery</span> Template-Based Search</h3>
                    <p>When a session has &ge;3 matched compressor cycles, their average magnitude and duration
                       establish a template. The remaining signal is searched within the session&rsquo;s time window
                       at a lower threshold (60% of average magnitude) for additional cycles that match the template.</p>
                    <svg viewBox="0 0 440 150" xmlns="http://www.w3.org/2000/svg">
                        <rect x="25" y="10" width="395" height="110" fill="#F8F9FF" rx="4"/>
                        <line x1="25" y1="125" x2="420" y2="125" stroke="#B0B0C0" stroke-width="1"/>
                        <line x1="25" y1="10" x2="25" y2="125" stroke="#B0B0C0" stroke-width="1"/>
                        <!-- Detected cycles -->
                        <rect x="40" y="55" width="50" height="70" fill="#5EB88A" fill-opacity="0.15" rx="2"/>
                        <rect x="100" y="55" width="50" height="70" fill="#5EB88A" fill-opacity="0.15" rx="2"/>
                        <rect x="160" y="55" width="50" height="70" fill="#5EB88A" fill-opacity="0.15" rx="2"/>
                        <text x="65" y="50" fill="#5EB88A" font-size="7" text-anchor="middle">matched</text>
                        <text x="125" y="50" fill="#5EB88A" font-size="7" text-anchor="middle">matched</text>
                        <text x="185" y="50" fill="#5EB88A" font-size="7" text-anchor="middle">matched</text>
                        <!-- Missed cycle -->
                        <rect x="220" y="75" width="50" height="50" fill="#D47070" fill-opacity="0.15" rx="2" stroke="#D47070" stroke-width="1" stroke-dasharray="4,2"/>
                        <text x="245" y="70" fill="#D47070" font-size="7" text-anchor="middle">missed</text>
                        <text x="245" y="105" fill="#D47070" font-size="7" text-anchor="middle">&lt; 800W</text>
                        <!-- Arrow showing recovery -->
                        <line x1="270" y1="100" x2="310" y2="100" stroke="#5EB88A" stroke-width="1.5" marker-end="url(#arrowGreen)"/>
                        <!-- Recovered -->
                        <rect x="315" y="75" width="50" height="50" fill="#5EB88A" fill-opacity="0.25" rx="2" stroke="#5EB88A" stroke-width="1.5"/>
                        <text x="340" y="70" fill="#5EB88A" font-size="7" text-anchor="middle">recovered</text>
                        <!-- Threshold annotation -->
                        <line x1="35" y1="88" x2="275" y2="88" stroke="#9090A0" stroke-width="0.7" stroke-dasharray="3,2"/>
                        <text x="280" y="91" fill="#9090A0" font-size="6">60% threshold</text>
                    </svg>
                    <p style="font-size:0.82em; color:#9090A0; margin-top:6px;">
                        <strong>Conservative:</strong> Requires &ge;3 existing matched cycles to establish a template.
                        Only searches within identified session time windows, not the full signal.
                        Reuses existing detection + matching + segmentation code.
                    </p>
                </div>
            </div>
        </section>

        <!-- Matching Types -->
        <section id="matching" class="m1-section">
            <h2>Matching</h2>
            <p style="color:#7D7D92; margin-bottom:15px;">
                After detection, ON events are paired with corresponding OFF events through three progressive matching stages.
                Unmatched events from each stage pass to the next. Progressive time windows: 15 &rarr; 30 &rarr; 60 &rarr; 120 &rarr; 240 &rarr; 360 min.
            </p>

            <div class="match-grid">
                <!-- Stage 1: Clean -->
                <div class="event-card">
                    <h3><span class="badge badge-clean">Stage 1</span> Clean Match</h3>
                    <p>Stable power between ON and OFF. No interference from other devices. Magnitudes match within 350W. Example: a boiler running alone on phase w3 for 40 minutes — quiet phase, no other device activity, ON=2000W and OFF=1980W.</p>
                    <svg viewBox="0 0 320 150" xmlns="http://www.w3.org/2000/svg">
                        <rect x="30" y="10" width="270" height="115" fill="#F8F9FF" rx="4"/>
                        <line x1="30" y1="35" x2="300" y2="35" stroke="#E0DCF0" stroke-dasharray="4"/>
                        <line x1="30" y1="60" x2="300" y2="60" stroke="#E0DCF0" stroke-dasharray="4"/>
                        <line x1="30" y1="85" x2="300" y2="85" stroke="#E0DCF0" stroke-dasharray="4"/>
                        <line x1="30" y1="125" x2="300" y2="125" stroke="#B0B0C0" stroke-width="1"/>
                        <line x1="30" y1="10" x2="30" y2="125" stroke="#B0B0C0" stroke-width="1"/>
                        <polyline points="40,100 70,100 80,100 85,40 130,40 175,40 220,40 225,100 260,100 290,100"
                                  fill="none" stroke="#3D3D50" stroke-width="2.5" stroke-linejoin="round"/>
                        <polygon points="85,40 85,100 225,100 225,40" fill="#5EB88A" fill-opacity="0.12"/>
                        <text x="85" y="112" fill="#5EB88A" font-size="9" font-weight="bold">ON</text>
                        <text x="219" y="112" fill="#D47070" font-size="9" font-weight="bold">OFF</text>
                        <text x="155" y="75" fill="#5EB88A" font-size="9" font-weight="bold" text-anchor="middle">stable</text>
                        <text x="155" y="145" fill="#7D7D92" font-size="8" text-anchor="middle">magnitude diff &lt; 350W</text>
                    </svg>
                </div>

                <!-- Stage 2: Noisy -->
                <div class="event-card">
                    <h3><span class="badge badge-noisy">Stage 2</span> Noisy Match</h3>
                    <p>Other devices cause power fluctuations between ON and OFF, but power never drops below baseline - 200W. Example: an AC running for 2 hours on a busy kitchen phase — the kettle and microwave cause spikes, but the total never falls below the AC's own consumption.</p>
                    <svg viewBox="0 0 320 150" xmlns="http://www.w3.org/2000/svg">
                        <rect x="30" y="10" width="270" height="115" fill="#F8F9FF" rx="4"/>
                        <line x1="30" y1="35" x2="300" y2="35" stroke="#E0DCF0" stroke-dasharray="4"/>
                        <line x1="30" y1="60" x2="300" y2="60" stroke="#E0DCF0" stroke-dasharray="4"/>
                        <line x1="30" y1="85" x2="300" y2="85" stroke="#E0DCF0" stroke-dasharray="4"/>
                        <line x1="30" y1="125" x2="300" y2="125" stroke="#B0B0C0" stroke-width="1"/>
                        <line x1="30" y1="10" x2="30" y2="125" stroke="#B0B0C0" stroke-width="1"/>
                        <polyline points="40,100 70,100 80,100 85,40 100,35 115,55 130,30 150,50 170,25 185,45 200,35 215,42 225,100 260,100 290,100"
                                  fill="none" stroke="#3D3D50" stroke-width="2.5" stroke-linejoin="round"/>
                        <polygon points="85,40 100,35 115,55 130,30 150,50 170,25 185,45 200,35 215,42 225,100 85,100" fill="#D4956A" fill-opacity="0.1"/>
                        <line x1="85" y1="60" x2="225" y2="60" stroke="#D4956A" stroke-width="1.5" stroke-dasharray="4,2"/>
                        <text x="155" y="57" fill="#D4956A" font-size="8" text-anchor="middle">min allowed</text>
                        <text x="85" y="112" fill="#5EB88A" font-size="9" font-weight="bold">ON</text>
                        <text x="219" y="112" fill="#D47070" font-size="9" font-weight="bold">OFF</text>
                        <text x="155" y="145" fill="#7D7D92" font-size="8" text-anchor="middle">tolerates interference</text>
                    </svg>
                </div>

                <!-- Stage 3: Partial -->
                <div class="event-card">
                    <h3><span class="badge badge-partial">Stage 3</span> Partial Match</h3>
                    <p>ON and OFF magnitudes differ by &gt;350W. Matches the smaller portion and creates a remainder event for the rest. Example: an AC (1500W) and boiler (2000W) turn on together → single +3500W event. The AC turns off first (-1500W), leaving a 2000W remainder for the boiler's OFF.</p>
                    <svg viewBox="0 0 320 150" xmlns="http://www.w3.org/2000/svg">
                        <rect x="30" y="10" width="270" height="115" fill="#F8F9FF" rx="4"/>
                        <line x1="30" y1="35" x2="300" y2="35" stroke="#E0DCF0" stroke-dasharray="4"/>
                        <line x1="30" y1="60" x2="300" y2="60" stroke="#E0DCF0" stroke-dasharray="4"/>
                        <line x1="30" y1="85" x2="300" y2="85" stroke="#E0DCF0" stroke-dasharray="4"/>
                        <line x1="30" y1="125" x2="300" y2="125" stroke="#B0B0C0" stroke-width="1"/>
                        <line x1="30" y1="10" x2="30" y2="125" stroke="#B0B0C0" stroke-width="1"/>
                        <polyline points="40,100 65,100 75,30 120,30 165,30 175,65 220,65 260,65 270,100 290,100"
                                  fill="none" stroke="#3D3D50" stroke-width="2.5" stroke-linejoin="round"/>
                        <polygon points="75,100 75,65 175,65 175,100" fill="#5EB88A" fill-opacity="0.12"/>
                        <polygon points="75,30 75,65 175,65 175,30" fill="#9070B4" fill-opacity="0.12"/>
                        <polygon points="175,65 175,100 270,100 270,65" fill="#9070B4" fill-opacity="0.08"/>
                        <text x="75" y="112" fill="#5EB88A" font-size="8" font-weight="bold">ON(A+B)</text>
                        <text x="170" y="112" fill="#D47070" font-size="8" font-weight="bold">OFF(B)</text>
                        <text x="125" y="86" fill="#5EB88A" font-size="8" text-anchor="middle">B matched</text>
                        <text x="125" y="50" fill="#9070B4" font-size="8" text-anchor="middle">A</text>
                        <text x="222" y="86" fill="#9070B4" font-size="8" text-anchor="middle">remainder</text>
                        <text x="155" y="145" fill="#7D7D92" font-size="8" text-anchor="middle">splits overlapping devices</text>
                    </svg>
                </div>
            </div>

            <!-- Why iterative matching helps -->
            <div class="event-card" style="max-width:100%; margin-top:25px; border-color:#5A90C0; border-width:1.5px;">
                <h3 style="color:#5A90C0;">Why iterative peeling improves matching</h3>
                <p>
                    The three matching stages above handle increasingly difficult scenarios within a <em>single</em> iteration.
                    But the real power comes from the <strong>iterative threshold schedule</strong> (2000W &rarr; 1500W &rarr; 1100W &rarr; 800W),
                    which addresses two fundamental problems:
                </p>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:18px; margin-top:15px;">
                    <div style="padding:16px; background:#EEF8F0; border-radius:8px; border:1px solid #D0ECD8;">
                        <h3 style="color:#3A6A4A; font-size:0.95em;">Nested events</h3>
                        <p style="font-size:0.85em;">
                            When a boiler (2000W) runs while an AC (1200W) cycles on top, the combined signal is hard to decompose.
                            At TH=2000W the first iteration catches the boiler and removes it.
                            In the next iteration at TH=1500W, the AC cycles appear cleanly in the remaining signal
                            — without the boiler's power masking them. Each stage of matching
                            (clean &rarr; noisy &rarr; partial) gets much higher accuracy when the large device is already gone.
                        </p>
                        <svg viewBox="0 0 340 100" xmlns="http://www.w3.org/2000/svg" style="max-width:340px; margin-top:8px;">
                            <!-- Before: AC cycles on top of boiler rectangle -->
                            <rect x="5" y="5" width="155" height="85" fill="#F8F9FF" rx="4" stroke="#E8E4F0"/>
                            <text x="82" y="18" fill="#7D7D92" font-size="7" font-weight="bold" text-anchor="middle">Before (combined)</text>
                            <!-- Boiler rectangle (constant 2000W base) -->
                            <rect x="30" y="50" width="100" height="20" fill="#F5E0E0" stroke="#D47070" stroke-width="0.8" rx="1"/>
                            <text x="80" y="63" fill="#D47070" font-size="5.5" text-anchor="middle">boiler</text>
                            <!-- AC cycles riding on top of boiler -->
                            <polyline points="15,70 30,70 30,50 35,50 40,28 55,28 60,50 65,50 70,28 85,28 90,50 95,50 100,28 115,28 120,50 130,50 130,70 140,70"
                                      fill="none" stroke="#3D3D50" stroke-width="1.8" stroke-linejoin="round"/>
                            <text x="82" y="82" fill="#D47070" font-size="6" text-anchor="middle">hard to match</text>

                            <!-- Arrow -->
                            <text x="170" y="52" fill="#B0B4D0" font-size="14" font-weight="bold">&#10132;</text>

                            <!-- After: clean AC cycles -->
                            <rect x="185" y="5" width="150" height="85" fill="#F8F9FF" rx="4" stroke="#E8E4F0"/>
                            <text x="260" y="18" fill="#7D7D92" font-size="7" font-weight="bold" text-anchor="middle">After boiler removed</text>
                            <polyline points="195,70 210,70 215,40 230,40 235,70 250,70 255,40 270,40 275,70 290,70 295,40 310,40 315,70 325,70"
                                      fill="none" stroke="#D4956A" stroke-width="1.8" stroke-linejoin="round"/>
                            <text x="260" y="82" fill="#5EB88A" font-size="6" text-anchor="middle">clean AC cycles</text>
                        </svg>
                    </div>
                    <div style="padding:16px; background:#EEF4FF; border-radius:8px; border:1px solid #C0D8F0;">
                        <h3 style="color:#4A7AA0; font-size:0.95em;">Lower threshold, higher precision</h3>
                        <p style="font-size:0.85em;">
                            A high threshold (2000W) only catches large, unambiguous events — there are few of them but each match
                            is very reliable (mostly clean Stage 1 matches). Once removed, the remaining signal has less interference,
                            so the next iteration at a lower threshold (1500W) can detect medium devices with better precision.
                            By the time we reach 800W, the signal is stripped of all large devices and the small events stand out clearly.
                        </p>
                        <div style="margin-top:10px; font-size:0.8em; color:#5D5D72;">
                            <div style="display:flex; align-items:center; gap:6px; margin:4px 0;">
                                <span style="display:inline-block; width:55px; padding:2px 6px; background:#3D3D50; color:white; border-radius:3px; text-align:center; font-weight:600;">2000W</span>
                                <span>Boilers — few events, very high confidence</span>
                            </div>
                            <div style="display:flex; align-items:center; gap:6px; margin:4px 0;">
                                <span style="display:inline-block; width:55px; padding:2px 6px; background:#5D5D72; color:white; border-radius:3px; text-align:center; font-weight:600;">1500W</span>
                                <span>Large ACs — boilers removed, cleaner signal</span>
                            </div>
                            <div style="display:flex; align-items:center; gap:6px; margin:4px 0;">
                                <span style="display:inline-block; width:55px; padding:2px 6px; background:#7D7D92; color:white; border-radius:3px; text-align:center; font-weight:600;">1100W</span>
                                <span>Medium ACs — large ACs also removed</span>
                            </div>
                            <div style="display:flex; align-items:center; gap:6px; margin:4px 0;">
                                <span style="display:inline-block; width:55px; padding:2px 6px; background:#B0B4D0; color:white; border-radius:3px; text-align:center; font-weight:600;">800W</span>
                                <span>Small devices — cleanest signal, highest precision</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Validation Gates -->
            <h3 id="validation" style="margin-top:30px; padding-top:20px; border-top:2px solid #E8E4F0;">Validation Gates</h3>
            <p style="color:#7D7D92; margin-bottom:15px;">
                Every candidate match passes through quality checks before being accepted. Matches that fail are rejected
                and their events return to the unmatched pool for the next stage.
            </p>

            <div class="validation-grid">
                <div class="validation-card">
                    <h3><span class="badge badge-validate">CV Stability</span></h3>
                    <p>The power during the event period must be stable. If the coefficient of variation (standard deviation / mean) exceeds the threshold, the signal is too erratic — likely two different devices overlapping rather than one steady device. Example: power zigzags between 1800W and 200W = multiple devices, not a single boiler.</p>
                    <div class="threshold">CV &le; 0.30 (30%)</div>
                    <svg viewBox="0 0 260 80" xmlns="http://www.w3.org/2000/svg" style="max-width:260px; margin-top:10px;">
                        <rect x="5" y="5" width="120" height="65" fill="#D8F0E0" fill-opacity="0.3" rx="4" stroke="#5EB88A" stroke-width="0.5"/>
                        <text x="65" y="17" fill="#5EB88A" font-size="7" text-anchor="middle" font-weight="bold">PASS</text>
                        <polyline points="15,45 30,42 45,48 60,44 75,46 90,43 105,45 115,44" fill="none" stroke="#5EB88A" stroke-width="1.5"/>
                        <text x="65" y="65" fill="#9090A0" font-size="6" text-anchor="middle">stable signal</text>

                        <rect x="135" y="5" width="120" height="65" fill="#F5D8D8" fill-opacity="0.3" rx="4" stroke="#D47070" stroke-width="0.5"/>
                        <text x="195" y="17" fill="#D47070" font-size="7" text-anchor="middle" font-weight="bold">REJECT</text>
                        <polyline points="145,50 155,25 165,55 175,20 185,60 195,30 205,50 215,25 225,55 240,35 245,50" fill="none" stroke="#D47070" stroke-width="1.5"/>
                        <text x="195" y="65" fill="#9090A0" font-size="6" text-anchor="middle">spiky signal</text>
                    </svg>
                </div>

                <div class="validation-card">
                    <h3><span class="badge badge-validate">Min Power Ratio</span></h3>
                    <p>Event power must stay above 50% of the ON magnitude throughout the activation period. A drop below this means the device likely turned off mid-period and the match is spanning across two different activations. Example: ON at 1500W matched with an OFF 3 hours later, but power dropped to 400W in between (ratio 0.27 &lt; 0.50).</p>
                    <div class="threshold">min(event_power) / magnitude &ge; 0.50</div>
                    <svg viewBox="0 0 260 80" xmlns="http://www.w3.org/2000/svg" style="max-width:260px; margin-top:10px;">
                        <rect x="5" y="5" width="120" height="65" fill="#D8F0E0" fill-opacity="0.3" rx="4" stroke="#5EB88A" stroke-width="0.5"/>
                        <text x="65" y="17" fill="#5EB88A" font-size="7" text-anchor="middle" font-weight="bold">PASS</text>
                        <polyline points="15,30 35,33 55,28 75,35 95,30 115,32" fill="none" stroke="#5EB88A" stroke-width="1.5"/>
                        <line x1="15" y1="45" x2="115" y2="45" stroke="#B0B0C0" stroke-width="0.5" stroke-dasharray="3"/>
                        <text x="65" y="52" fill="#9090A0" font-size="5">50% line</text>

                        <rect x="135" y="5" width="120" height="65" fill="#F5D8D8" fill-opacity="0.3" rx="4" stroke="#D47070" stroke-width="0.5"/>
                        <text x="195" y="17" fill="#D47070" font-size="7" text-anchor="middle" font-weight="bold">REJECT</text>
                        <polyline points="145,30 160,32 175,35 185,50 195,58 210,55 225,30 245,32" fill="none" stroke="#D47070" stroke-width="1.5"/>
                        <line x1="145" y1="45" x2="245" y2="45" stroke="#B0B0C0" stroke-width="0.5" stroke-dasharray="3"/>
                        <text x="195" y="65" fill="#9090A0" font-size="5">drops below 50%</text>
                    </svg>
                </div>

                <div class="validation-card">
                    <h3><span class="badge badge-validate">Negative Check</span></h3>
                    <p>Remaining power after subtracting the device must not go negative. Small negatives (&gt; -10W) trigger automatic magnitude correction instead of rejection. Example: measured ON was 1505W but the device actually draws 1500W — the 5W rounding error would create -5W remaining, so the magnitude is reduced by 5W.</p>
                    <div class="threshold">remaining &ge; -10W (tolerance)</div>
                    <svg viewBox="0 0 260 80" xmlns="http://www.w3.org/2000/svg" style="max-width:260px; margin-top:10px;">
                        <rect x="5" y="5" width="75" height="65" fill="#D8F0E0" fill-opacity="0.3" rx="4" stroke="#5EB88A" stroke-width="0.5"/>
                        <text x="42" y="17" fill="#5EB88A" font-size="6" text-anchor="middle" font-weight="bold">PASS</text>
                        <text x="42" y="42" fill="#5EB88A" font-size="9" text-anchor="middle">+12W</text>

                        <rect x="92" y="5" width="75" height="65" fill="#F5ECD5" fill-opacity="0.5" rx="4" stroke="#D4956A" stroke-width="0.5"/>
                        <text x="130" y="17" fill="#D4956A" font-size="6" text-anchor="middle" font-weight="bold">CORRECT</text>
                        <text x="130" y="42" fill="#D4956A" font-size="9" text-anchor="middle">-5W</text>
                        <text x="130" y="55" fill="#9090A0" font-size="5" text-anchor="middle">reduce mag.</text>

                        <rect x="180" y="5" width="75" height="65" fill="#F5D8D8" fill-opacity="0.3" rx="4" stroke="#D47070" stroke-width="0.5"/>
                        <text x="217" y="17" fill="#D47070" font-size="6" text-anchor="middle" font-weight="bold">REJECT</text>
                        <text x="217" y="42" fill="#D47070" font-size="9" text-anchor="middle">-50W</text>
                    </svg>
                </div>
            </div>
            <!-- Match Tag System -->
            <h3 id="tags" style="margin-top:30px; padding-top:20px; border-top:2px solid #E8E4F0;">Match Tag System</h3>
            <p style="color:#7D7D92; margin-bottom:15px;">
                Each match receives a descriptive tag combining stage prefix, magnitude quality, and duration:
            </p>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                <div>
                    <h3>Magnitude Quality</h3>
                    <table class="tags-table">
                        <tr><th>Tag</th><th>&Delta; Magnitude</th><th>Meaning</th></tr>
                        <tr><td><span class="tag-badge" style="background:#D8F0E0;color:#3A6A4A;">EXACT</span></td><td>&lt; 50W</td><td>ON and OFF nearly identical — a boiler that turns on at 2010W and off at 1990W</td></tr>
                        <tr><td><span class="tag-badge" style="background:#D0E4F4;color:#2A5A7A;">CLOSE</span></td><td>50–100W</td><td>Small variance from measurement noise or background drift during the activation</td></tr>
                        <tr><td><span class="tag-badge" style="background:#F5ECD5;color:#6A5A2A;">APPROX</span></td><td>100–200W</td><td>Another small device turned on/off during the event, slightly shifting the measured magnitude</td></tr>
                        <tr><td><span class="tag-badge" style="background:#F5D8D8;color:#6A3030;">LOOSE</span></td><td>200–350W</td><td>Significant interference — e.g., a light or fan switched during an AC cycle, distorting the OFF measurement</td></tr>
                    </table>
                </div>
                <div>
                    <h3>Duration Category</h3>
                    <table class="tags-table">
                        <tr><th>Tag</th><th>Duration</th><th>Examples</th></tr>
                        <tr><td><span class="tag-badge" style="background:#EAE8F0;color:#505060;">SPIKE</span></td><td>&le; 2 min</td><td>Compressor inrush current that settles within 1-2 minutes, or measurement noise — too brief to be a meaningful device activation</td></tr>
                        <tr><td><span class="tag-badge" style="background:#EAE8F0;color:#505060;">QUICK</span></td><td>2–5 min</td><td>Electric kettle boiling water (3-4 min), microwave heating food, or a very short AC compressor cycle when the room is almost at temperature</td></tr>
                        <tr><td><span class="tag-badge" style="background:#EAE8F0;color:#505060;">MEDIUM</span></td><td>5–30 min</td><td>Single AC compressor cooling cycle (5-20 min), washing machine heating water, or an iron in use</td></tr>
                        <tr><td><span class="tag-badge" style="background:#EAE8F0;color:#505060;">EXTENDED</span></td><td>&gt; 30 min</td><td>Boiler heating the water tank (30-45 min), oven baking, or central AC running continuously during summer peak</td></tr>
                    </table>
                </div>
            </div>
            <div style="margin-top:20px;">
                <h3>Suffixes</h3>
                <table class="tags-table">
                    <tr><th>Suffix</th><th>Trigger</th><th>Meaning</th></tr>
                    <tr>
                        <td><span class="tag-badge" style="background:#D4956A22;color:#A87040;">-TAIL</span></td>
                        <td>OFF event was tail-extended</td>
                        <td>The OFF event's end time was extended forward to capture residual power decay, increasing the detected magnitude</td>
                    </tr>
                    <tr>
                        <td><span class="tag-badge" style="background:#D4707022;color:#A06060;">-CORRECTED</span></td>
                        <td>Small negative remaining (&gt; -10W)</td>
                        <td>Match magnitude was reduced slightly to prevent negative remaining power after segmentation</td>
                    </tr>
                </table>
            </div>
            <p style="color:#7D7D92; margin-top:15px; font-size:0.88em;">
                <strong>Full format:</strong>
                <code style="background:#F0EEF6; padding:2px 6px; border-radius:3px;">[NOISY- | PARTIAL-] {EXACT|CLOSE|APPROX|LOOSE} - {SPIKE|QUICK|MEDIUM|EXTENDED} [-CORRECTED] [-TAIL]</code>
            </p>
            <p style="color:#9090A0; margin-top:6px; font-size:0.82em;">
                Examples: <code style="background:#F0EEF6; padding:1px 4px; border-radius:2px;">EXACT-MEDIUM</code>,
                <code style="background:#F0EEF6; padding:1px 4px; border-radius:2px;">NOISY-APPROX-EXTENDED-CORRECTED</code>,
                <code style="background:#F0EEF6; padding:1px 4px; border-radius:2px;">CLOSE-MEDIUM-TAIL</code>,
                <code style="background:#F0EEF6; padding:1px 4px; border-radius:2px;">PARTIAL-EXTENDED-CORRECTED</code>
            </p>
        </section>

        <!-- Segmentation -->
        <section id="segmentation" class="m1-section">
            <h2>Segmentation</h2>
            <p style="color:#7D7D92; margin-bottom:15px;">
                After matching, device power is extracted from the total signal. Three different extraction strategies are used
                depending on the match quality, ensuring accurate separation even under noisy or overlapping conditions:
            </p>

            <div class="seg-grid">
                <!-- Standard Path -->
                <div class="event-card">
                    <h3><span class="badge badge-seg">Standard</span> Clean Extraction</h3>
                    <p>For Stage 1 matches. Device power follows the actual ON ramp, holds constant during the event, then follows the OFF ramp. Clipped to remaining power to prevent negatives. Example: a boiler at 2000W for 35 minutes on a quiet phase — just subtract its flat 2000W from the total signal.</p>
                    <svg viewBox="0 0 300 140" xmlns="http://www.w3.org/2000/svg">
                        <rect x="25" y="10" width="255" height="105" fill="#F8F9FF" rx="4"/>
                        <line x1="25" y1="120" x2="280" y2="120" stroke="#B0B0C0" stroke-width="1"/>
                        <line x1="25" y1="10" x2="25" y2="120" stroke="#B0B0C0" stroke-width="1"/>
                        <!-- Total power -->
                        <polyline points="35,100 55,100 65,40 110,40 155,40 200,40 210,100 250,100 270,100"
                                  fill="none" stroke="#B0B0C0" stroke-width="1.5" stroke-dasharray="4,2"/>
                        <!-- Extracted device power -->
                        <polyline points="35,120 55,120 65,60 110,60 155,60 200,60 210,120 250,120 270,120"
                                  fill="none" stroke="#3A6A9A" stroke-width="2.5" stroke-linejoin="round"/>
                        <polygon points="65,60 65,120 210,120 210,60" fill="#3A6A9A" fill-opacity="0.1"/>
                        <!-- Remaining power -->
                        <polyline points="35,100 55,100 65,100 110,100 155,100 200,100 210,100 250,100 270,100"
                                  fill="none" stroke="#5EB88A" stroke-width="1.5"/>
                        <!-- Labels -->
                        <text x="137" y="85" fill="#3A6A9A" font-size="8" text-anchor="middle">device power</text>
                        <text x="252" y="95" fill="#5EB88A" font-size="7">remaining</text>
                        <text x="137" y="135" fill="#7D7D92" font-size="7" text-anchor="middle">constant extraction, clipped to remaining</text>
                    </svg>
                </div>

                <!-- Noisy Path -->
                <div class="event-card">
                    <h3><span class="badge badge-seg">Noisy</span> Interference-Aware</h3>
                    <p>For Stage 2 matches. Device power is clipped to min(magnitude, remaining) at each minute. Accounts for other devices interfering during the event period. Example: an AC at 1500W while someone uses the kettle — at some minutes the remaining power is only 1200W, so extraction is capped at 1200W for those minutes.</p>
                    <svg viewBox="0 0 300 140" xmlns="http://www.w3.org/2000/svg">
                        <rect x="25" y="10" width="255" height="105" fill="#F8F9FF" rx="4"/>
                        <line x1="25" y1="120" x2="280" y2="120" stroke="#B0B0C0" stroke-width="1"/>
                        <line x1="25" y1="10" x2="25" y2="120" stroke="#B0B0C0" stroke-width="1"/>
                        <!-- Total power (noisy) -->
                        <polyline points="35,100 55,100 65,40 85,30 105,55 125,35 145,50 165,30 185,45 200,40 210,100 250,100 270,100"
                                  fill="none" stroke="#B0B0C0" stroke-width="1.5" stroke-dasharray="4,2"/>
                        <!-- Extracted device power (variable) -->
                        <polyline points="35,120 55,120 65,65 85,65 105,65 125,65 145,65 165,65 185,65 200,65 210,120 250,120 270,120"
                                  fill="none" stroke="#3A6A9A" stroke-width="2.5" stroke-linejoin="round"/>
                        <polygon points="65,65 65,120 210,120 210,65" fill="#3A6A9A" fill-opacity="0.1"/>
                        <!-- Labels -->
                        <text x="137" y="98" fill="#3A6A9A" font-size="8" text-anchor="middle">device power</text>
                        <text x="137" y="135" fill="#7D7D92" font-size="7" text-anchor="middle">clipped to min(magnitude, remaining)</text>
                    </svg>
                </div>

                <!-- Partial Path -->
                <div class="event-card">
                    <h3><span class="badge badge-seg">Partial</span> Split Extraction</h3>
                    <p>For Stage 3 matches. Only the matched portion (smaller magnitude) is extracted. The remainder continues as a separate event for future matching. Example: a combined 3500W ON (AC + boiler) — only the 1500W AC portion is extracted now, leaving the 2000W boiler portion for a separate match.</p>
                    <svg viewBox="0 0 300 140" xmlns="http://www.w3.org/2000/svg">
                        <rect x="25" y="10" width="255" height="105" fill="#F8F9FF" rx="4"/>
                        <line x1="25" y1="120" x2="280" y2="120" stroke="#B0B0C0" stroke-width="1"/>
                        <line x1="25" y1="10" x2="25" y2="120" stroke="#B0B0C0" stroke-width="1"/>
                        <!-- Total power -->
                        <polyline points="35,100 55,100 65,30 110,30 155,30 165,65 210,65 250,65 260,100 270,100"
                                  fill="none" stroke="#B0B0C0" stroke-width="1.5" stroke-dasharray="4,2"/>
                        <!-- Extracted: only the matched portion -->
                        <polyline points="35,120 55,120 65,85 110,85 155,85 165,120 210,120 250,120 270,120"
                                  fill="none" stroke="#3A6A9A" stroke-width="2.5" stroke-linejoin="round"/>
                        <polygon points="65,85 65,120 165,120 165,85" fill="#3A6A9A" fill-opacity="0.1"/>
                        <!-- Remainder stays -->
                        <polygon points="65,30 65,85 165,85 165,65 210,65 250,65 260,100 65,100" fill="#9070B4" fill-opacity="0.06" stroke="#9070B4" stroke-width="0.5" stroke-dasharray="3"/>
                        <!-- Labels -->
                        <text x="110" y="107" fill="#3A6A9A" font-size="7" text-anchor="middle">matched B</text>
                        <text x="155" y="55" fill="#9070B4" font-size="7" text-anchor="middle">A remains</text>
                        <text x="147" y="135" fill="#7D7D92" font-size="7" text-anchor="middle">extracts only matched portion</text>
                    </svg>
                </div>
            </div>
        </section>

        <!-- ═══════════════════════════════════════════════════════ -->
        <!-- SEGMENTATOR: Waves                                     -->
        <!-- ═══════════════════════════════════════════════════════ -->
        <div class="module-banner post-m1">
            <div class="module-number" style="font-size:1.5em;">SEG</div>
            <div class="module-info">
                <h2>Segmentator &mdash; Wave Recovery</h2>
                <p>The wave sub-module of the Segmentator. Scans the remaining power signal after rectangle matching for <strong>wave-shaped patterns</strong> &mdash; sharp power rise followed by gradual monotonic decay. These are AC compressor cycles that rectangles missed because the ON magnitude is much larger than the OFF magnitude, causing ON/OFF matching to fail. Also performs <strong>cross-phase search</strong> (critical for 3-phase central AC) and <strong>hole repair</strong> &mdash; fixes rectangle matches that incorrectly extracted wave-shaped patterns as flat rectangles.</p>
            </div>
        </div>

        <section id="wave-recovery" class="postm1-section">
            <h2>Wave Recovery &mdash; Pipeline Overview</h2>
            <p style="color:#7D7D92; margin-bottom:15px;">
                Runs <strong>once</strong>, after all 4 rectangle iterations and guided cycle recovery complete.
                Detects wave-shaped compressor patterns in the remaining signal, extracts their power contribution,
                and produces match records in the same format as rectangle matches &mdash; the Identifier picks them up seamlessly.
            </p>

            <div class="pipeline-flow">
                <div class="pipeline-step" style="background:linear-gradient(135deg, #D4956A, #FFCBA4);">Detect Waves</div>
                <span class="pipeline-arrow">&#10132;</span>
                <div class="pipeline-step" style="background:linear-gradient(135deg, #D4956A, #FFCBA4);">Cross-Phase Match</div>
                <span class="pipeline-arrow">&#10132;</span>
                <div class="pipeline-step" style="background:linear-gradient(135deg, #D4956A, #FFCBA4);">Extract &amp; Validate</div>
                <span class="pipeline-arrow">&#10132;</span>
                <div class="pipeline-step" style="background:linear-gradient(135deg, #B05A30, #D4956A);">Hole Repair</div>
                <span class="pipeline-arrow">&#10132;</span>
                <div class="pipeline-step" style="background:linear-gradient(135deg, #D4956A, #FFCBA4);">Save Matches</div>
            </div>

            <!-- Sub-pipeline: grouped by stage with headers -->
            <div style="margin-top:12px; display:flex; flex-direction:column; gap:8px;">
                <!-- Detection -->
                <div class="sub-pipeline" style="border-color:#E8D4B0;">
                    <span style="font-size:0.72em; font-weight:700; color:#8A5A30; text-transform:uppercase; letter-spacing:0.05em; margin-right:6px;">Detection</span>
                    <span class="sub-step" style="background:#FFF5EC;color:#7A5030;">Load Remaining</span>
                    <span class="sub-arrow">&#8594;</span>
                    <span class="sub-step" style="background:#FFF5EC;color:#7A5030;">Sharp Rise (&ge;500W)</span>
                    <span class="sub-arrow">&#8594;</span>
                    <span class="sub-step" style="background:#FFF5EC;color:#7A5030;">Monotonic Decay</span>
                </div>
                <!-- Matching -->
                <div class="sub-pipeline" style="border-color:#E8D4B0;">
                    <span style="font-size:0.72em; font-weight:700; color:#8A5A30; text-transform:uppercase; letter-spacing:0.05em; margin-right:6px;">Matching</span>
                    <span class="sub-step" style="background:#F8EAD8;color:#7A5030;">Cross-Phase Search</span>
                    <span class="sub-arrow">&#8594;</span>
                    <span class="sub-step" style="background:#F8EAD8;color:#7A5030;">Validate</span>
                </div>
                <!-- Segmentation -->
                <div class="sub-pipeline" style="border-color:#E8D4B0;">
                    <span style="font-size:0.72em; font-weight:700; color:#8A5A30; text-transform:uppercase; letter-spacing:0.05em; margin-right:6px;">Segmentation</span>
                    <span class="sub-step" style="background:#F8EAD8;color:#7A5030;">Extract Wave Shape</span>
                    <span class="sub-arrow">&#8594;</span>
                    <span class="sub-step" style="background:#EAE8F0;color:#505060;">WAVE-* Matches</span>
                </div>
                <!-- Hole Repair -->
                <div class="sub-pipeline" style="border-color:#C08060;">
                    <span style="font-size:0.72em; font-weight:700; color:#8A4020; text-transform:uppercase; letter-spacing:0.05em; margin-right:6px;">Hole Repair</span>
                    <span class="sub-step" style="background:#F5E0D0;color:#7A4020;">Tag Filter (APPROX/LOOSE)</span>
                    <span class="sub-arrow">&#8594;</span>
                    <span class="sub-step" style="background:#F5E0D0;color:#7A4020;">Detect Holes</span>
                    <span class="sub-arrow">&#8594;</span>
                    <span class="sub-step" style="background:#F5E0D0;color:#7A4020;">Build Wave Profile</span>
                    <span class="sub-arrow">&#8594;</span>
                    <span class="sub-step" style="background:#EAE8F0;color:#505060;">WAVE-REPAIR-* Matches</span>
                </div>
            </div>

            <p class="pipeline-desc">
                Input: final <code>summarized_*.pkl</code> (remaining power after all rectangle iterations).<br>
                Output: <code>run_post/house_{id}/matches/matches_*.pkl</code> (same DataFrame format, tagged <code>WAVE-MEDIUM</code>, <code>WAVE-EXTENDED</code>, <code>WAVE-REPAIR-EXTENDED</code>, etc.).<br>
                These are automatically loaded by the Identifier's <code>load_all_matches()</code>.
            </p>

            <!-- Why rectangle matching fails — visual comparison -->
            <div class="event-grid" style="margin-top:20px;">
                <div class="event-card" style="border-color:#D4956A; border-left:4px solid #D4956A;">
                    <h3>Why rectangle matching fails on some compressors</h3>
                    <p>Rectangle matching assumes ON &asymp; OFF magnitude. But some AC compressors start at high power
                       (e.g. 3000W) and gradually decrease as the refrigerant pressure equalises (e.g. to 1500W over 15 minutes).
                       The <strong>ON is 2x the OFF</strong>, so no rectangle match is possible. These cycles stay in the
                       remaining signal as unexplained power &mdash; the wave sub-module recovers them.</p>
                    <svg viewBox="0 0 480 130" xmlns="http://www.w3.org/2000/svg" style="max-width:480px;">
                        <rect x="10" y="5" width="220" height="110" fill="#F8F9FF" rx="4" stroke="#E8E4F0"/>
                        <text x="120" y="20" fill="#7D7D92" font-size="8" font-weight="bold" text-anchor="middle">Rectangle (ON &asymp; OFF)</text>
                        <polyline points="25,90 50,90 55,30 100,30 145,30 150,90 200,90 220,90" fill="none" stroke="#5A90C0" stroke-width="2.5" stroke-linejoin="round"/>
                        <line x1="55" y1="28" x2="55" y2="92" stroke="#5EB88A" stroke-width="1" stroke-dasharray="4,2"/>
                        <text x="48" y="60" fill="#5EB88A" font-size="7" text-anchor="end">ON</text>
                        <line x1="150" y1="28" x2="150" y2="92" stroke="#D47070" stroke-width="1" stroke-dasharray="4,2"/>
                        <text x="157" y="60" fill="#D47070" font-size="7">OFF</text>
                        <text x="100" y="70" fill="#5EB88A" font-size="8" text-anchor="middle" font-weight="bold">&#10003;</text>
                        <text x="120" y="118" fill="#9090A0" font-size="7" text-anchor="middle">ON = 1500W, OFF = 1500W &rarr; match</text>

                        <text x="240" y="62" fill="#B0B4D0" font-size="14" font-weight="bold">vs</text>

                        <rect x="260" y="5" width="220" height="110" fill="#FFF5EC" rx="4" stroke="#E8D4B0"/>
                        <text x="370" y="20" fill="#7A5030" font-size="8" font-weight="bold" text-anchor="middle">Wave (ON &gt;&gt; OFF)</text>
                        <polyline points="275,90 300,90 305,25 315,35 330,45 350,55 370,63 390,70 410,78 430,85 450,88 465,90" fill="none" stroke="#D4956A" stroke-width="2.5" stroke-linejoin="round"/>
                        <line x1="305" y1="23" x2="305" y2="92" stroke="#5EB88A" stroke-width="1" stroke-dasharray="4,2"/>
                        <text x="298" y="55" fill="#5EB88A" font-size="7" text-anchor="end">ON</text>
                        <text x="298" y="65" fill="#5EB88A" font-size="7" text-anchor="end">3000W</text>
                        <line x1="450" y1="83" x2="450" y2="92" stroke="#D47070" stroke-width="1" stroke-dasharray="4,2"/>
                        <text x="457" y="82" fill="#D47070" font-size="7">OFF 200W</text>
                        <text x="380" y="50" fill="#D47070" font-size="8" text-anchor="middle" font-weight="bold">&#10007;</text>
                        <text x="370" y="118" fill="#9090A0" font-size="7" text-anchor="middle">ON = 3000W, OFF = 200W &rarr; no match</text>
                    </svg>
                </div>
            </div>
        </section>

        <!-- Wave Detection Algorithm (detailed) -->
        <section id="wave-detection" class="postm1-section">
            <h2>Wave Detection Algorithm</h2>
            <p style="color:#7D7D92; margin-bottom:15px;">
                Scans each phase's remaining power independently.
                Finds sharp rises (&ge;500W in a single minute), then validates the decay pattern that follows.
            </p>

            <div class="event-grid">
                <div class="event-card" style="border-color:#D4956A;">
                    <h3>Step 1: Find sharp rises</h3>
                    <p>Compute minute-to-minute diffs on the remaining signal.
                       Any diff &ge; <code>wave_min_rise_watts</code> (default 500W) is a candidate wave start.
                       The baseline is the value just before the rise.</p>
                    <svg viewBox="0 0 380 120" xmlns="http://www.w3.org/2000/svg">
                        <rect x="30" y="5" width="330" height="90" fill="#F8F9FF" rx="4"/>
                        <line x1="30" y1="100" x2="360" y2="100" stroke="#B0B0C0" stroke-width="1"/>
                        <line x1="30" y1="5" x2="30" y2="100" stroke="#B0B0C0" stroke-width="1"/>
                        <polyline points="40,85 80,85 120,85 160,85 170,20 210,35 250,50 290,65 330,80 350,85"
                                  fill="none" stroke="#3D3D50" stroke-width="2.5" stroke-linejoin="round"/>
                        <line x1="160" y1="20" x2="160" y2="85" stroke="#D4956A" stroke-width="2" stroke-dasharray="5,3"/>
                        <text x="153" y="55" fill="#D4956A" font-size="9" font-weight="bold" text-anchor="end">&ge;500W</text>
                        <polygon points="157,45 163,45 160,35" fill="#D4956A"/>
                        <polygon points="157,70 163,70 160,80" fill="#D4956A"/>
                        <text x="168" y="15" fill="#D47070" font-size="7">peak</text>
                        <text x="155" y="112" fill="#9090A0" font-size="7" text-anchor="end">baseline</text>
                        <line x1="30" y1="85" x2="160" y2="85" stroke="#9090A0" stroke-width="0.5" stroke-dasharray="3,2"/>
                    </svg>
                </div>

                <div class="event-card" style="border-color:#D4956A;">
                    <h3>Step 2: Validate monotonic decay</h3>
                    <p>Starting from the peak, scan forward. Each minute should be &le; the previous value.
                       Up to <strong>15% of steps</strong> may increase (tolerance for measurement noise).
                       If more than 15% increase, the pattern is rejected as non-wave (likely a different device).</p>
                    <svg viewBox="0 0 380 120" xmlns="http://www.w3.org/2000/svg">
                        <rect x="30" y="5" width="330" height="90" fill="#F8F9FF" rx="4"/>
                        <line x1="30" y1="100" x2="360" y2="100" stroke="#B0B0C0" stroke-width="1"/>
                        <line x1="30" y1="5" x2="30" y2="100" stroke="#B0B0C0" stroke-width="1"/>
                        <!-- Good: monotonic with 1 violation -->
                        <polyline points="40,20 70,30 100,42 115,38 140,50 170,62 200,72 230,80 260,85 290,88 330,90"
                                  fill="none" stroke="#5EB88A" stroke-width="2.5" stroke-linejoin="round"/>
                        <circle cx="115" cy="38" r="4" fill="#D4956A" stroke="#D4956A" stroke-width="1"/>
                        <text x="115" y="30" fill="#D4956A" font-size="7" text-anchor="middle">+4W (ok)</text>
                        <text x="185" y="112" fill="#5EB88A" font-size="8" text-anchor="middle">&#10003; 1/10 increases = 10% &lt; 15% tolerance</text>
                    </svg>
                </div>
            </div>

            <div class="event-grid" style="margin-top:15px;">
                <div class="event-card" style="border-color:#D4956A;">
                    <h3>Step 3: Validate duration &amp; decay fraction</h3>
                    <p>The wave must last between <strong>3 and 45 minutes</strong>.
                       Power must decay at least <strong>30% from peak</strong> (if it stays flat, it's a rectangle, not a wave).
                       The end is detected when the signal returns within 5% of baseline.</p>
                    <div style="display:flex; gap:12px; margin-top:10px;">
                        <div style="flex:1; padding:10px; background:#D8F0E0; border-radius:6px; font-size:0.85em;">
                            <strong style="color:#3A6A4A;">Accept:</strong><br>
                            Duration: 3&ndash;45 min<br>
                            Decay: peak &minus; end &ge; 30% of (peak &minus; baseline)
                        </div>
                        <div style="flex:1; padding:10px; background:#F5D8D8; border-radius:6px; font-size:0.85em;">
                            <strong style="color:#6A3030;">Reject:</strong><br>
                            Duration &lt;3 min (spike, not compressor)<br>
                            Duration &gt;45 min (unlikely single cycle)<br>
                            Decay &lt;30% (flat pattern = rectangle)
                        </div>
                    </div>
                </div>

                <div class="event-card" style="border-color:#D4956A;">
                    <h3>Output: WavePattern object</h3>
                    <p>Each detected wave produces a <code>WavePattern</code> containing all the information needed
                       for extraction and match record creation:</p>
                    <div style="font-size:0.85em; margin-top:8px; font-family:monospace; color:#5D5D72; background:#F8F9FF; padding:10px; border-radius:6px;">
                        start &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: 2021-07-15 18:00<br>
                        peak_time &nbsp;&nbsp;&nbsp;: 2021-07-15 18:01<br>
                        end &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: 2021-07-15 18:16<br>
                        phase &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: w1<br>
                        peak_power &nbsp;&nbsp;: 2500W<br>
                        baseline &nbsp;&nbsp;&nbsp;&nbsp;: 200W<br>
                        duration &nbsp;&nbsp;&nbsp;&nbsp;: 15 min<br>
                        wave_profile : [2300, 2100, 1900, ...]
                    </div>
                </div>
            </div>
        </section>

        <!-- Cross-Phase Search (detailed) -->
        <section id="cross-phase" class="postm1-section">
            <h2>Cross-Phase Search</h2>
            <p style="color:#7D7D92; margin-bottom:15px;">
                Central AC systems operate across 2&ndash;3 electrical phases. When a wave is detected on one phase,
                the other phases are searched in the same time window for similar patterns &mdash; even at lower magnitudes.
                This is the key mechanism that enables 3-phase central AC detection.
            </p>

            <div class="event-card" style="max-width:100%; border-color:#D4956A;">
                <h3>Algorithm: relaxed threshold on aligned phases</h3>
                <svg viewBox="0 0 650 180" xmlns="http://www.w3.org/2000/svg" style="width:100%; max-width:650px; display:block; margin:12px auto 0;">
                    <!-- Phase labels -->
                    <text x="20" y="45" fill="#5A90C0" font-size="11" font-weight="bold">w1</text>
                    <text x="20" y="95" fill="#5EB88A" font-size="11" font-weight="bold">w2</text>
                    <text x="20" y="145" fill="#D4956A" font-size="11" font-weight="bold">w3</text>

                    <!-- Timeline lines -->
                    <line x1="45" y1="40" x2="400" y2="40" stroke="#E8E4F0" stroke-width="1"/>
                    <line x1="45" y1="90" x2="400" y2="90" stroke="#E8E4F0" stroke-width="1"/>
                    <line x1="45" y1="140" x2="400" y2="140" stroke="#E8E4F0" stroke-width="1"/>

                    <!-- W1: strong wave (detected normally) -->
                    <polyline points="80,40 100,40 105,15 115,20 130,25 150,30 170,33 190,36 210,38 230,40 260,40"
                              fill="none" stroke="#5A90C0" stroke-width="2.5" stroke-linejoin="round"/>
                    <text x="108" y="12" fill="#5A90C0" font-size="7" font-weight="bold">2500W</text>
                    <rect x="95" y="8" width="140" height="35" fill="none" stroke="#5A90C0" stroke-width="1.5" stroke-dasharray="4,2" rx="4"/>
                    <text x="270" y="30" fill="#5A90C0" font-size="8" font-weight="bold">&#10003; detected (rise &ge;500W)</text>

                    <!-- W2: weaker wave (below threshold, found via cross-phase) -->
                    <polyline points="80,90 102,90 108,70 118,73 130,76 148,80 168,83 188,86 208,88 230,90 260,90"
                              fill="none" stroke="#5EB88A" stroke-width="2.5" stroke-linejoin="round"/>
                    <text x="110" y="65" fill="#5EB88A" font-size="7">800W</text>
                    <rect x="98" y="62" width="135" height="32" fill="none" stroke="#5EB88A" stroke-width="1.5" stroke-dasharray="4,2" rx="4"/>
                    <text x="270" y="82" fill="#D47070" font-size="8">&#10007; below 500W threshold</text>
                    <text x="270" y="95" fill="#5EB88A" font-size="8" font-weight="bold">&#10003; found via W1 (250W relaxed)</text>

                    <!-- W3: flat (no wave) -->
                    <polyline points="80,140 120,140 160,140 200,140 240,140 260,140"
                              fill="none" stroke="#D4956A" stroke-width="2" stroke-linejoin="round"/>
                    <text x="270" y="143" fill="#9090A0" font-size="8">&#10007; no wave pattern</text>

                    <!-- Time window indicator -->
                    <rect x="90" y="0" width="150" height="160" fill="#D4956A" fill-opacity="0.05" rx="4" stroke="#D4956A" stroke-width="1" stroke-dasharray="6,3"/>
                    <text x="165" y="175" fill="#D4956A" font-size="8" text-anchor="middle" font-weight="bold">&plusmn;5 min search window</text>

                    <!-- Right side: summary -->
                    <rect x="420" y="15" width="220" height="140" fill="#FFF5EC" rx="8" stroke="#E8D4B0" stroke-width="1.5"/>
                    <text x="530" y="38" fill="#7A5030" font-size="10" font-weight="bold" text-anchor="middle">Cross-Phase Rules</text>
                    <text x="435" y="58" fill="#5D5D72" font-size="8">1. Wave found on phase X</text>
                    <text x="435" y="75" fill="#5D5D72" font-size="8">2. Search Y, Z in [start&minus;5, end+5] min</text>
                    <text x="435" y="92" fill="#5D5D72" font-size="8">3. Threshold = 50% of normal</text>
                    <text x="447" y="105" fill="#9090A0" font-size="7">(500W &times; 0.5 = 250W)</text>
                    <text x="435" y="122" fill="#5D5D72" font-size="8">4. Skip already-detected waves</text>
                    <text x="435" y="139" fill="#5D5D72" font-size="8">5. Mark source: &ldquo;via W1 template&rdquo;</text>
                </svg>
                <p style="font-size:0.85em; color:#7D7D92; margin-top:10px;">
                    <strong>Why 50% relaxation?</strong> In 3-phase central AC, one phase typically carries the strongest compressor load
                    (W1: 2500W), while the other phases carry weaker loads from fans and secondary compressor circuits
                    (W2: 800W, W3: 600W). Without cross-phase search, these weaker phases would have 0 detected waves,
                    and the Identifier would never see synchronized multi-phase activity &mdash; missing the central AC entirely.
                </p>
            </div>
        </section>

        <!-- Wave Power Extraction (detailed) -->
        <section id="wave-extraction" class="postm1-section">
            <h2>Wave Power Extraction</h2>
            <p style="color:#7D7D92; margin-bottom:15px;">
                Once a wave is detected, its power contribution is extracted from the remaining signal
                following the wave's actual shape &mdash; not as a flat rectangle.
            </p>

            <div class="event-grid">
                <div class="event-card" style="border-color:#D4956A;">
                    <h3>Shape-following extraction</h3>
                    <p>For each minute in [start, end]: <code>extract[t] = min(remaining[t] - baseline, wave_profile[t])</code>.
                       The extraction follows the wave's exponential decay shape rather than a flat block. This is more
                       physically accurate &mdash; the compressor actually draws decreasing power over time.</p>
                    <svg viewBox="0 0 400 140" xmlns="http://www.w3.org/2000/svg">
                        <rect x="25" y="5" width="355" height="110" fill="#F8F9FF" rx="4"/>
                        <line x1="25" y1="120" x2="380" y2="120" stroke="#B0B0C0" stroke-width="1"/>
                        <line x1="25" y1="5" x2="25" y2="120" stroke="#B0B0C0" stroke-width="1"/>
                        <!-- Remaining before extraction -->
                        <polyline points="40,100 70,100 80,20 100,30 130,45 160,58 190,68 220,76 250,82 280,88 310,95 340,100 360,100"
                                  fill="none" stroke="#B0B0C0" stroke-width="1.5" stroke-dasharray="4,2"/>
                        <text x="365" y="98" fill="#B0B0C0" font-size="6">before</text>
                        <!-- Wave-shaped extraction -->
                        <polygon points="80,20 80,100 310,100 310,95 280,88 250,82 220,76 190,68 160,58 130,45 100,30" fill="#D4956A" fill-opacity="0.15"/>
                        <polyline points="80,20 100,30 130,45 160,58 190,68 220,76 250,82 280,88 310,95"
                                  fill="none" stroke="#D4956A" stroke-width="2.5" stroke-linejoin="round"/>
                        <text x="195" y="75" fill="#D4956A" font-size="8" text-anchor="middle" font-weight="bold">extracted wave</text>
                        <!-- Remaining after = baseline -->
                        <polyline points="40,100 70,100 80,100 310,100 340,100 360,100"
                                  fill="none" stroke="#5EB88A" stroke-width="2" stroke-linejoin="round"/>
                        <text x="365" y="105" fill="#5EB88A" font-size="6">after</text>
                        <!-- Baseline label -->
                        <line x1="25" y1="100" x2="380" y2="100" stroke="#9090A0" stroke-width="0.5" stroke-dasharray="3,2"/>
                        <text x="18" y="103" fill="#9090A0" font-size="6">base</text>
                        <text x="200" y="135" fill="#7D7D92" font-size="7" text-anchor="middle">extraction follows the actual decay curve, not a flat block</text>
                    </svg>
                </div>

                <div class="event-card" style="border-color:#D4956A;">
                    <h3>Validation checks</h3>
                    <p>Every extraction is validated before being accepted:</p>
                    <div style="font-size:0.85em; margin-top:8px;">
                        <div style="display:flex; align-items:center; gap:8px; margin:6px 0;">
                            <span style="display:inline-block; width:8px; height:8px; background:#5EB88A; border-radius:50%;"></span>
                            <span><strong>No negatives</strong> &mdash; remaining &ge; 0 everywhere after extraction</span>
                        </div>
                        <div style="display:flex; align-items:center; gap:8px; margin:6px 0;">
                            <span style="display:inline-block; width:8px; height:8px; background:#5EB88A; border-radius:50%;"></span>
                            <span><strong>Power invariant</strong> &mdash; before = after + extracted at every minute</span>
                        </div>
                        <div style="display:flex; align-items:center; gap:8px; margin:6px 0;">
                            <span style="display:inline-block; width:8px; height:8px; background:#5EB88A; border-radius:50%;"></span>
                            <span><strong>No zero-gaps</strong> &mdash; &lt;30% of wave duration has zero extraction</span>
                        </div>
                        <div style="display:flex; align-items:center; gap:8px; margin:6px 0;">
                            <span style="display:inline-block; width:8px; height:8px; background:#5EB88A; border-radius:50%;"></span>
                            <span><strong>Non-zero total</strong> &mdash; total extracted power must be &gt;0</span>
                        </div>
                    </div>
                    <p style="margin-top:10px; font-size:0.82em; color:#9090A0;">
                        <strong>Match records</strong> use the same DataFrame columns as rectangles:
                        <code>on_event_id</code>, <code>off_event_id</code>, <code>on_start/end</code>,
                        <code>off_start/end</code>, <code>duration</code>, <code>on_magnitude</code>,
                        <code>off_magnitude</code>, <code>tag</code>, <code>phase</code>.
                        Tags: <code>WAVE-SPIKE</code>, <code>WAVE-QUICK</code>, <code>WAVE-MEDIUM</code>,
                        <code>WAVE-EXTENDED</code>.
                    </p>
                </div>
            </div>
        </section>

        <!-- Hole Repair -->
        <section id="hole-repair" class="postm1-section">
            <h2>Hole Repair</h2>
            <p style="color:#7D7D92; margin-bottom:15px;">
                Sometimes M1 rectangle matching forces a <strong>wave-shaped</strong> compressor pattern into a flat rectangle.
                The ON magnitude is much larger than the OFF magnitude, so the match gets an <code>APPROX</code> or <code>LOOSE</code> tag.
                The constant-power extraction drains the remaining signal to near-zero during the decay phase, creating a <strong>"hole"</strong>.
                Hole repair finds these bad extractions, undoes them, and re-extracts as a proper wave shape.
            </p>

            <div class="event-grid">
                <div class="event-card" style="border-color:#B05A30; border-left:4px solid #B05A30;">
                    <h3>How holes form</h3>
                    <p>When rectangle matching extracts a constant magnitude (e.g. 2000W for 40 minutes) from a signal that
                       actually decays from 2000W to 200W, the extraction is too aggressive during the decay phase.
                       The remaining signal drops to &asymp;0W where the real power was already lower than the extracted rectangle.</p>
                    <svg viewBox="0 0 480 140" xmlns="http://www.w3.org/2000/svg" style="max-width:480px;">
                        <!-- Before: wave as rectangle -->
                        <rect x="10" y="5" width="220" height="120" fill="#F8F9FF" rx="4" stroke="#E8E4F0"/>
                        <text x="120" y="20" fill="#7D7D92" font-size="8" font-weight="bold" text-anchor="middle">Rectangle extraction (wrong)</text>
                        <!-- Actual signal: wave shape -->
                        <polyline points="25,100 40,100 45,25 65,35 85,50 105,60 125,70 145,78 165,85 185,92 200,100"
                                  fill="none" stroke="#D4956A" stroke-width="2" stroke-linejoin="round" stroke-dasharray="4,2"/>
                        <text x="195" y="55" fill="#D4956A" font-size="7">actual signal</text>
                        <!-- Extracted rectangle (constant) -->
                        <polygon points="45,25 45,100 200,100 200,25" fill="#5A90C0" fill-opacity="0.15" stroke="#5A90C0" stroke-width="1.5" stroke-dasharray="3"/>
                        <text x="120" y="65" fill="#5A90C0" font-size="8" text-anchor="middle">constant 2000W</text>
                        <!-- Hole region -->
                        <rect x="100" y="85" width="100" height="15" fill="#D47070" fill-opacity="0.2" rx="2"/>
                        <text x="150" y="95" fill="#D47070" font-size="7" text-anchor="middle">hole (&asymp; 0W)</text>

                        <text x="240" y="65" fill="#B0B4D0" font-size="14" font-weight="bold">&#10132;</text>

                        <!-- After: wave extraction -->
                        <rect x="260" y="5" width="220" height="120" fill="#FFF5EC" rx="4" stroke="#E8D4B0"/>
                        <text x="370" y="20" fill="#8A4020" font-size="8" font-weight="bold" text-anchor="middle">Wave extraction (repaired)</text>
                        <polyline points="275,100 290,100 295,25 315,35 335,50 355,60 375,70 395,78 415,85 435,92 450,100"
                                  fill="none" stroke="#D4956A" stroke-width="2" stroke-linejoin="round"/>
                        <polygon points="295,25 315,35 335,50 355,60 375,70 395,78 415,85 435,92 450,100 450,100 295,100"
                                 fill="#D4956A" fill-opacity="0.15"/>
                        <text x="370" y="85" fill="#D4956A" font-size="8" text-anchor="middle">follows decay shape</text>
                    </svg>
                </div>

                <div class="event-card" style="border-color:#B05A30;">
                    <h3>Repair algorithm</h3>
                    <div style="font-size:0.88em; color:#5D5D72;">
                        <div style="display:flex; align-items:flex-start; gap:8px; margin:8px 0;">
                            <span style="display:inline-block; min-width:22px; height:22px; background:#F5E0D0; border-radius:50%; text-align:center; line-height:22px; font-weight:bold; font-size:0.8em; color:#7A4020;">1</span>
                            <span><strong>Filter by tag</strong>: scan M1 matches for <code>APPROX</code>/<code>LOOSE</code> + <code>EXTENDED</code> or <code>CORRECTED</code> + <code>EXTENDED</code> &mdash; these indicate ON &ne; OFF magnitude in long events (wave signature)</span>
                        </div>
                        <div style="display:flex; align-items:flex-start; gap:8px; margin:8px 0;">
                            <span style="display:inline-block; min-width:22px; height:22px; background:#F5E0D0; border-radius:50%; text-align:center; line-height:22px; font-weight:bold; font-size:0.8em; color:#7A4020;">2</span>
                            <span><strong>Detect hole</strong>: check if &ge;30% of the event region in <code>remaining</code> is near-zero (&lt;50W)</span>
                        </div>
                        <div style="display:flex; align-items:flex-start; gap:8px; margin:8px 0;">
                            <span style="display:inline-block; min-width:22px; height:22px; background:#F5E0D0; border-radius:50%; text-align:center; line-height:22px; font-weight:bold; font-size:0.8em; color:#7A4020;">3</span>
                            <span><strong>Restore</strong>: undo the rectangle extraction by adding constant magnitude back to remaining</span>
                        </div>
                        <div style="display:flex; align-items:flex-start; gap:8px; margin:8px 0;">
                            <span style="display:inline-block; min-width:22px; height:22px; background:#F5E0D0; border-radius:50%; text-align:center; line-height:22px; font-weight:bold; font-size:0.8em; color:#7A4020;">4</span>
                            <span><strong>Build wave profile</strong>: construct a linear-decay profile from <code>on_magnitude</code> &rarr; <code>off_magnitude</code> using match metadata (no re-detection needed)</span>
                        </div>
                        <div style="display:flex; align-items:flex-start; gap:8px; margin:8px 0;">
                            <span style="display:inline-block; min-width:22px; height:22px; background:#F5E0D0; border-radius:50%; text-align:center; line-height:22px; font-weight:bold; font-size:0.8em; color:#7A4020;">5</span>
                            <span><strong>Re-extract</strong>: extract the wave-shaped power from restored remaining, remove the original rectangle match, save as <code>WAVE-REPAIR-EXTENDED</code></span>
                        </div>
                    </div>
                    <p style="margin-top:10px; font-size:0.82em; color:#9090A0;">
                        Key insight: we don't re-detect the wave &mdash; we already know it's there from the M1 match metadata.
                        The ON/OFF magnitudes and timestamps give us enough information to construct the decay profile directly.
                    </p>
                </div>
            </div>
        </section>

        <!-- ═══════════════════════════════════════════════════════ -->
        <!-- IDENTIFIER                                             -->
        <!-- ═══════════════════════════════════════════════════════ -->
        <div class="module-banner module2">
            <div class="module-number" style="font-size:1.5em;">ID</div>
            <div class="module-info">
                <h2>Identifier &mdash; Rule-Based Device Classification</h2>
                <p>Takes all matched ON/OFF pairs from the Segmentator (both rectangle matches and wave matches), filters transient noise (spikes &lt;3 min), and classifies events in <strong>priority order</strong>: boiler (event-level, with 3-phase check), AC (pattern-based cycling detection), then groups remaining into unknown sessions. Session-level confidence scoring. No machine learning &mdash; purely heuristic rules based on domain knowledge of Israeli household electrical systems.</p>
            </div>
        </div>

        <!-- Identifier Pipeline Overview -->
        <section id="identifier-pipeline" class="m2-section">
            <h2>Identifier Pipeline</h2>
            <p style="color:#7D7D92; margin-bottom:15px;">
                The Identifier runs <strong>once</strong>, after the entire Segmentator (rectangles + waves) completes. It uses a
                <strong>classify-first, group-second</strong> approach: instead of grouping all events by time proximity and then classifying,
                it classifies events at the <strong>individual level</strong> in priority order. Boilers are identified first (each event = one session,
                with 3-phase simultaneity check), AC patterns are detected as cycling sequences, and only remaining unclassified events are grouped
                by the 30-minute gap rule.
            </p>
            <div class="pipeline-flow">
                <div class="pipeline-step" style="background:linear-gradient(135deg, #5EB88A, #B8E6C8);">Spike Filter</div>
                <span class="pipeline-arrow">&#10132;</span>
                <div class="pipeline-step" style="background:#D47070;">Boiler + 3-Phase</div>
                <span class="pipeline-arrow">&#10132;</span>
                <div class="pipeline-step" style="background:#5A90C0;">AC Detection</div>
                <span class="pipeline-arrow">&#10132;</span>
                <div class="pipeline-step" style="background:#8890A0;">Unknown (30-min)</div>
                <span class="pipeline-arrow">&#10132;</span>
                <div class="pipeline-step" style="background:linear-gradient(135deg, #5EB88A, #B8E6C8);">Confidence</div>
            </div>

            <!-- Detailed sub-steps -->
            <div style="margin-top:12px; display:flex; flex-direction:column; gap:8px;">
                <!-- Preprocessing -->
                <div class="sub-pipeline" style="border-color:#D0ECD8;">
                    <span style="font-size:0.72em; font-weight:700; color:#3A6A4A; text-transform:uppercase; letter-spacing:0.05em; margin-right:6px;">Preprocessing</span>
                    <span class="sub-step" style="background:#D0ECD8;color:#3A6A4A;">Load All Matches</span>
                    <span class="sub-arrow">&#8594;</span>
                    <span class="sub-step" style="background:#D0ECD8;color:#3A6A4A;">Filter Spikes (&lt;3 min)</span>
                </div>
                <!-- Step 1: Boiler -->
                <div class="sub-pipeline" style="border-color:#F0C0C0;">
                    <span style="font-size:0.72em; font-weight:700; color:#6A3030; text-transform:uppercase; letter-spacing:0.05em; margin-right:6px;">Step 1: Boiler</span>
                    <span class="sub-step" style="background:#F5D8D8;color:#6A3030;">Event-Level ID</span>
                    <span class="sub-arrow">&#8594;</span>
                    <span class="sub-step" style="background:#E0D0F0;color:#5A40A0;">3-Phase Check</span>
                    <span class="sub-arrow">&#8594;</span>
                    <span class="sub-step" style="background:#F5D8D8;color:#6A3030;">Phase Exclusivity</span>
                    <span class="sub-arrow">&#8594;</span>
                    <span class="sub-step" style="background:#D8F0E0;color:#3A6A4A;">Remove from pool</span>
                </div>
                <!-- Step 2: AC -->
                <div class="sub-pipeline" style="border-color:#C0D8F0;">
                    <span style="font-size:0.72em; font-weight:700; color:#2A5A7A; text-transform:uppercase; letter-spacing:0.05em; margin-right:6px;">Step 2: AC</span>
                    <span class="sub-step" style="background:#D0E4F4;color:#2A5A7A;">Find Cycling Sequences</span>
                    <span class="sub-arrow">&#8594;</span>
                    <span class="sub-step" style="background:#D0E4F4;color:#2A5A7A;">Cross-Phase Overlap?</span>
                    <span class="sub-arrow">&#8594;</span>
                    <span class="sub-step" style="background:#F5ECD5;color:#6A5A2A;">Central / Regular AC</span>
                    <span class="sub-arrow">&#8594;</span>
                    <span class="sub-step" style="background:#D8F0E0;color:#3A6A4A;">Remove from pool</span>
                </div>
                <!-- Step 3: Unknown -->
                <div class="sub-pipeline" style="border-color:#D8D8E0;">
                    <span style="font-size:0.72em; font-weight:700; color:#505060; text-transform:uppercase; letter-spacing:0.05em; margin-right:6px;">Step 3: Unknown</span>
                    <span class="sub-step" style="background:#EAE8F0;color:#505060;">Group Remaining (30-min gap)</span>
                    <span class="sub-arrow">&#8594;</span>
                    <span class="sub-step" style="background:#EAE8F0;color:#505060;">Unknown Confidence</span>
                </div>
                <!-- Output -->
                <div class="sub-pipeline" style="border-color:#D0ECD8;">
                    <span style="font-size:0.72em; font-weight:700; color:#3A6A4A; text-transform:uppercase; letter-spacing:0.05em; margin-right:6px;">Output</span>
                    <span class="sub-step" style="background:#E5D8F0;color:#6A50A0;">Confidence Score</span>
                    <span class="sub-arrow">&#8594;</span>
                    <span class="sub-step" style="background:#EAE8F0;color:#505060;">JSON Export</span>
                </div>
            </div>

            <p class="pipeline-desc">
                Input: <code>matches_*.pkl</code> from all 4 rectangle iterations (run_0 through run_3) + wave recovery matches from <code>run_post/</code>.<br>
                Output: <code>device_sessions_{house_id}.json</code> (session-level) +
                <code>device_activations_{house_id}.json</code> (backward-compatible flat format).<br>
                The Identifier is source-agnostic &mdash; it treats rectangle matches and wave matches identically since they share the same DataFrame schema.
            </p>

            <!-- Key concept: classify-first vs group-first -->
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:20px;">
                <div style="padding:18px; background:#F5D8D8; border-radius:8px; border:1px solid #F0C0C0; text-align:center;">
                    <div style="font-size:1.2em; font-weight:bold; color:#6A3030;">Before (group-first)</div>
                    <p style="font-size:0.85em; color:#5D5D72; margin-top:6px;">
                        Group ALL events by 30-min gap &rarr; classify sessions.<br>
                        Problem: small unrelated events near a boiler get dragged into it.<br>
                        Problem: 3 simultaneous boiler-like events on different phases = 3 separate boilers.
                    </p>
                </div>
                <div style="padding:18px; background:#D8F0E0; border-radius:8px; border:1px solid #C0D8C0; text-align:center;">
                    <div style="font-size:1.2em; font-weight:bold; color:#3A6A4A;">After (classify-first)</div>
                    <p style="font-size:0.85em; color:#5D5D72; margin-top:6px;">
                        Classify events individually &rarr; group only unknowns.<br>
                        Boiler = always 1 event = 1 session (no accidental grouping).<br>
                        3-phase simultaneous events = single <strong>three_phase_device</strong>.
                    </p>
                </div>
            </div>

            <!-- Key concept: match → session → device -->
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:20px; margin-top:20px;">
                <div style="padding:18px; background:#EEF8F0; border-radius:8px; border:1px solid #D0ECD8; text-align:center;">
                    <div style="font-size:1.8em; font-weight:bold; color:#3A6A4A;">Match</div>
                    <p style="font-size:0.85em; color:#5D5D72; margin-top:6px;">
                        One ON/OFF pair from the Segmentator.<br>
                        Has: start, end, duration, magnitude, phase, tag.<br>
                        <em>Example: ON 18:00 OFF 18:15, 1500W, w1, EXACT-MEDIUM</em>
                    </p>
                </div>
                <div style="padding:18px; background:#EEF8F0; border-radius:8px; border:1px solid #D0ECD8; text-align:center;">
                    <div style="font-size:1.8em; font-weight:bold; color:#3A6A4A;">Session</div>
                    <p style="font-size:0.85em; color:#5D5D72; margin-top:6px;">
                        Boiler: always 1 event = 1 session (event-level).<br>
                        AC: cycling sequence on same phase.<br>
                        Unknown: remaining events grouped by 30-min gap.
                    </p>
                </div>
                <div style="padding:18px; background:#EEF8F0; border-radius:8px; border:1px solid #D0ECD8; text-align:center;">
                    <div style="font-size:1.8em; font-weight:bold; color:#3A6A4A;">Device</div>
                    <p style="font-size:0.85em; color:#5D5D72; margin-top:6px;">
                        A session classified as a known device type.<br>
                        Has: type (boiler/three_phase_device/central_ac/regular_ac), confidence, factors.<br>
                        <em>Example: regular_ac, confidence 0.85, 5 cycles</em>
                    </p>
                </div>
            </div>
        </section>

        <!-- Transient Event Filter (Spike Filter) -->
        <section id="spike-filter" class="m2-section">
            <h2>Transient Event Filter (Spike Filter)</h2>
            <p style="color:#7D7D92; margin-bottom:15px;">
                Before identification, matched events shorter than <strong>3 minutes</strong> are filtered out.
                This project works with <strong>1-minute resolution</strong> data (not sub-second like lab NILM datasets)
                and uses a purely <strong>unsupervised, heuristic approach</strong> &mdash; no ML models, no additional
                features beyond power magnitude. Given these constraints, we focus on devices with
                <strong>consistent, recognisable usage patterns</strong>: boilers (long, high-power, daily),
                central AC (multi-phase synchronised), and regular AC (compressor cycling).
            </p>
            <p style="color:#7D7D92; margin-bottom:15px;">
                Transient events under 3 minutes &mdash; microwave bursts, oven heating elements,
                washing machine motor starts, inrush currents &mdash; are appliances whose usage patterns
                cannot be reliably identified from 1-minute power data alone. No classification rule
                accepts events shorter than 3 minutes (boiler &ge;15 min, AC cycle &ge;3 min), so filtering
                them is a statement of scope, not an assumption about the data.
            </p>

            <svg viewBox="0 0 750 220" xmlns="http://www.w3.org/2000/svg" style="width:100%; max-width:750px; display:block; margin:12px auto 0;">
                <!-- Input: All matches from M1 -->
                <rect x="5" y="10" width="340" height="160" fill="#F8F9FF" rx="5" stroke="#E8E4F0"/>
                <text x="175" y="28" fill="#3D3D50" font-size="10" font-weight="bold" text-anchor="middle">All Matches from Segmentator</text>

                <!-- Timeline -->
                <line x1="20" y1="110" x2="330" y2="110" stroke="#8890A0" stroke-width="0.5" stroke-dasharray="3,2"/>

                <!-- Spike 1 (1 min) -->
                <rect x="30" y="70" width="8" height="40" fill="#D47070" fill-opacity="0.3" rx="1"/>
                <text x="34" y="65" fill="#D47070" font-size="7" text-anchor="middle">1m</text>

                <!-- Good event (25 min boiler) -->
                <rect x="55" y="45" width="80" height="65" fill="#5EB88A" fill-opacity="0.15" rx="2"/>
                <text x="95" y="85" fill="#5EB88A" font-size="8" text-anchor="middle" font-weight="bold">25 min</text>
                <text x="95" y="95" fill="#5EB88A" font-size="7" text-anchor="middle">boiler</text>

                <!-- Spike 2 (2 min) -->
                <rect x="145" y="75" width="12" height="35" fill="#D47070" fill-opacity="0.3" rx="1"/>
                <text x="151" y="70" fill="#D47070" font-size="7" text-anchor="middle">2m</text>

                <!-- Spike 3 (1 min) -->
                <rect x="168" y="72" width="8" height="38" fill="#D47070" fill-opacity="0.3" rx="1"/>
                <text x="172" y="67" fill="#D47070" font-size="7" text-anchor="middle">1m</text>

                <!-- Good event (8 min AC cycle) -->
                <rect x="190" y="55" width="45" height="55" fill="#5EB88A" fill-opacity="0.15" rx="2"/>
                <text x="212" y="85" fill="#5EB88A" font-size="8" text-anchor="middle" font-weight="bold">8 min</text>
                <text x="212" y="95" fill="#5EB88A" font-size="7" text-anchor="middle">AC</text>

                <!-- Spike 4 (1 min) -->
                <rect x="250" y="68" width="8" height="42" fill="#D47070" fill-opacity="0.3" rx="1"/>
                <text x="254" y="63" fill="#D47070" font-size="7" text-anchor="middle">1m</text>

                <!-- Good event (5 min) -->
                <rect x="270" y="60" width="30" height="50" fill="#5EB88A" fill-opacity="0.15" rx="2"/>
                <text x="285" y="88" fill="#5EB88A" font-size="8" text-anchor="middle" font-weight="bold">5 min</text>

                <!-- Spike 5 (2 min) -->
                <rect x="310" y="74" width="12" height="36" fill="#D47070" fill-opacity="0.3" rx="1"/>
                <text x="316" y="69" fill="#D47070" font-size="7" text-anchor="middle">2m</text>

                <!-- Legend -->
                <rect x="20" y="130" width="10" height="10" fill="#D47070" fill-opacity="0.3" rx="1"/>
                <text x="34" y="139" fill="#D47070" font-size="7">Spike (&lt;3 min) &mdash; filtered out</text>
                <rect x="160" y="130" width="10" height="10" fill="#5EB88A" fill-opacity="0.15" rx="1" stroke="#5EB88A" stroke-width="0.5"/>
                <text x="174" y="139" fill="#5EB88A" font-size="7">Classifiable (&ge;3 min) &mdash; kept</text>

                <!-- Arrow -->
                <line x1="350" y1="90" x2="390" y2="90" stroke="#5EB88A" stroke-width="2"/>
                <polygon points="388,86 396,90 388,94" fill="#5EB88A"/>

                <!-- Output: Filtered matches -->
                <rect x="400" y="10" width="340" height="160" fill="#EEF8F0" rx="5" stroke="#5EB88A"/>
                <text x="570" y="28" fill="#3A6A4A" font-size="10" font-weight="bold" text-anchor="middle">Filtered Matches &rarr; Identification</text>

                <line x1="415" y1="110" x2="725" y2="110" stroke="#8890A0" stroke-width="0.5" stroke-dasharray="3,2"/>

                <!-- Only good events remain -->
                <rect x="430" y="45" width="80" height="65" fill="#5EB88A" fill-opacity="0.2" rx="2" stroke="#5EB88A" stroke-width="1"/>
                <text x="470" y="85" fill="#3A6A4A" font-size="8" text-anchor="middle" font-weight="bold">25 min</text>
                <text x="470" y="95" fill="#3A6A4A" font-size="7" text-anchor="middle">boiler</text>

                <rect x="540" y="55" width="45" height="55" fill="#5EB88A" fill-opacity="0.2" rx="2" stroke="#5EB88A" stroke-width="1"/>
                <text x="562" y="85" fill="#3A6A4A" font-size="8" text-anchor="middle" font-weight="bold">8 min</text>
                <text x="562" y="95" fill="#3A6A4A" font-size="7" text-anchor="middle">AC</text>

                <rect x="615" y="60" width="30" height="50" fill="#5EB88A" fill-opacity="0.2" rx="2" stroke="#5EB88A" stroke-width="1"/>
                <text x="630" y="88" fill="#3A6A4A" font-size="8" text-anchor="middle" font-weight="bold">5 min</text>

                <!-- Stats box -->
                <rect x="420" y="128" width="300" height="35" fill="#E0F4F0" rx="4"/>
                <text x="570" y="143" fill="#3A6A4A" font-size="8" text-anchor="middle">Spikes removed: transient noise from microwave, oven, motor starts</text>
                <text x="570" y="155" fill="#3A6A4A" font-size="7" text-anchor="middle">No classification rule accepts duration &lt; 3 min &mdash; this is a fact, not an assumption</text>

                <!-- Bottom explanation -->
                <text x="375" y="195" fill="#7D7D92" font-size="9" text-anchor="middle">Filter threshold: duration &lt; 3 minutes (aligns with AC_MIN_CYCLE_DURATION = 3 min)</text>
                <text x="375" y="210" fill="#9090A0" font-size="8" text-anchor="middle">Spike stats (count, total minutes, by iteration) saved to session JSON for transparency</text>
            </svg>
        </section>

        <!-- Session Grouping -->
        <section id="sessions" class="m2-section">
            <h2>Session Grouping (Unknowns Only)</h2>
            <p style="color:#7D7D92; margin-bottom:15px;">
                In the classify-first architecture, time-proximity grouping only applies to <strong>events remaining after
                boiler and AC classification</strong>. These leftover events are sorted by start time per phase and grouped
                into sessions: if the gap between one event's end and the next event's start exceeds
                <strong>30 minutes</strong>, a new session begins. Boiler events (1 event = 1 session) and AC cycling
                sequences are already classified before this step runs.
            </p>

            <!-- Session grouping timeline SVG -->
            <div class="event-grid">
                <div class="event-card" style="max-width:100%; grid-column:1/-1;">
                    <h3>Temporal Grouping (30-minute gap rule)</h3>
                    <svg viewBox="0 0 700 160" xmlns="http://www.w3.org/2000/svg" style="width:100%; max-width:700px; display:block; margin:12px auto 0;">
                        <!-- Timeline axis -->
                        <line x1="30" y1="70" x2="680" y2="70" stroke="#B0B0C0" stroke-width="1.5"/>
                        <text x="30" y="90" fill="#9090A0" font-size="7" text-anchor="middle">08:00</text>
                        <text x="680" y="90" fill="#9090A0" font-size="7" text-anchor="middle">12:00</text>

                        <!-- Event blocks on the timeline (phase w1) -->
                        <text x="15" y="55" fill="#5A90C0" font-size="9" font-weight="bold">w1</text>

                        <!-- Event 1: 08:10-08:25 -->
                        <rect x="52" y="48" width="40" height="22" fill="#5A90C0" fill-opacity="0.25" rx="3" stroke="#5A90C0" stroke-width="1.5"/>
                        <text x="72" y="63" fill="#2A5A7A" font-size="6" text-anchor="middle">15 min</text>

                        <!-- Gap: 8 min (short, same session) -->
                        <line x1="92" y1="75" x2="110" y2="75" stroke="#5EB88A" stroke-width="1.5"/>
                        <text x="101" y="100" fill="#5EB88A" font-size="7" text-anchor="middle">8 min</text>

                        <!-- Event 2: 08:33-08:43 -->
                        <rect x="110" y="48" width="28" height="22" fill="#5A90C0" fill-opacity="0.25" rx="3" stroke="#5A90C0" stroke-width="1.5"/>
                        <text x="124" y="63" fill="#2A5A7A" font-size="6" text-anchor="middle">10 min</text>

                        <!-- Gap: 5 min -->
                        <line x1="138" y1="75" x2="150" y2="75" stroke="#5EB88A" stroke-width="1.5"/>
                        <text x="144" y="100" fill="#5EB88A" font-size="7" text-anchor="middle">5 min</text>

                        <!-- Event 3: 08:48-09:00 -->
                        <rect x="150" y="48" width="32" height="22" fill="#5A90C0" fill-opacity="0.25" rx="3" stroke="#5A90C0" stroke-width="1.5"/>
                        <text x="166" y="63" fill="#2A5A7A" font-size="6" text-anchor="middle">12 min</text>

                        <!-- Gap: 12 min -->
                        <line x1="182" y1="75" x2="210" y2="75" stroke="#5EB88A" stroke-width="1.5"/>
                        <text x="196" y="100" fill="#5EB88A" font-size="7" text-anchor="middle">12 min</text>

                        <!-- Event 4: 09:12-09:22 -->
                        <rect x="210" y="48" width="28" height="22" fill="#5A90C0" fill-opacity="0.25" rx="3" stroke="#5A90C0" stroke-width="1.5"/>
                        <text x="224" y="63" fill="#2A5A7A" font-size="6" text-anchor="middle">10 min</text>

                        <!-- Session 1 bracket -->
                        <line x1="52" y1="35" x2="238" y2="35" stroke="#5EB88A" stroke-width="2"/>
                        <line x1="52" y1="32" x2="52" y2="38" stroke="#5EB88A" stroke-width="2"/>
                        <line x1="238" y1="32" x2="238" y2="38" stroke="#5EB88A" stroke-width="2"/>
                        <text x="145" y="28" fill="#5EB88A" font-size="8" font-weight="bold" text-anchor="middle">Session 1 (4 cycles, ~72 min)</text>

                        <!-- ====== BIG GAP ====== -->
                        <line x1="238" y1="75" x2="430" y2="75" stroke="#D47070" stroke-width="2" stroke-dasharray="6,3"/>
                        <text x="334" y="100" fill="#D47070" font-size="8" font-weight="bold" text-anchor="middle">&gt; 30 min gap &rarr; new session</text>

                        <!-- Event 5: 10:45-11:20 (long boiler-like) -->
                        <rect x="430" y="48" width="95" height="22" fill="#D47070" fill-opacity="0.2" rx="3" stroke="#D47070" stroke-width="1.5"/>
                        <text x="477" y="63" fill="#6A3030" font-size="6" text-anchor="middle">35 min</text>

                        <!-- Session 2 bracket -->
                        <line x1="430" y1="35" x2="525" y2="35" stroke="#D47070" stroke-width="2"/>
                        <line x1="430" y1="32" x2="430" y2="38" stroke="#D47070" stroke-width="2"/>
                        <line x1="525" y1="32" x2="525" y2="38" stroke="#D47070" stroke-width="2"/>
                        <text x="477" y="28" fill="#D47070" font-size="8" font-weight="bold" text-anchor="middle">Session 2 (1 cycle, 35 min)</text>

                        <!-- Big gap again -->
                        <line x1="525" y1="75" x2="580" y2="75" stroke="#D47070" stroke-width="2" stroke-dasharray="6,3"/>

                        <!-- Event 6: 11:40-11:50 -->
                        <rect x="580" y="48" width="28" height="22" fill="#5A90C0" fill-opacity="0.25" rx="3" stroke="#5A90C0" stroke-width="1.5"/>
                        <text x="594" y="63" fill="#2A5A7A" font-size="6" text-anchor="middle">10 min</text>

                        <!-- Event 7: 11:55-12:00 -->
                        <rect x="615" y="48" width="16" height="22" fill="#5A90C0" fill-opacity="0.25" rx="3" stroke="#5A90C0" stroke-width="1.5"/>
                        <text x="623" y="63" fill="#2A5A7A" font-size="6" text-anchor="middle">5 min</text>

                        <!-- Session 3 bracket -->
                        <line x1="580" y1="35" x2="631" y2="35" stroke="#5A90C0" stroke-width="2"/>
                        <line x1="580" y1="32" x2="580" y2="38" stroke="#5A90C0" stroke-width="2"/>
                        <line x1="631" y1="32" x2="631" y2="38" stroke="#5A90C0" stroke-width="2"/>
                        <text x="605" y="28" fill="#5A90C0" font-size="8" font-weight="bold" text-anchor="middle">Session 3</text>

                        <!-- Legend -->
                        <text x="355" y="130" fill="#7D7D92" font-size="8" text-anchor="middle">Each rectangle = one matched ON/OFF pair. Session 1 has 4 compressor cycles (likely AC).</text>
                        <text x="355" y="143" fill="#7D7D92" font-size="8" text-anchor="middle">Session 2 has 1 long event (likely boiler). Sessions are classified independently.</text>
                    </svg>
                </div>
            </div>

            <!-- How wave matches integrate -->
            <div style="margin-top:20px;">
                <div class="event-card" style="max-width:100%; border-color:#D4956A; border-left:4px solid #D4956A;">
                    <h3>Wave matches in session grouping</h3>
                    <p>Wave matches (tagged <code>WAVE-*</code>) are loaded alongside rectangle matches and sorted by start time.
                       They participate in session grouping identically: if a wave match on w1 at 18:10 falls within
                       30 minutes of a rectangle match on w1 at 18:00, they join the same session. This means a session
                       can contain <strong>both rectangle and wave matches</strong> &mdash; the Identifier sees compressor cycles
                       regardless of which sub-module detected them. This is especially important for central AC,
                       where some phases may only have wave-detected cycles.</p>
                </div>
            </div>

            <!-- Session splitting (post-processing) -->
            <div style="margin-top:20px;">
                <div class="event-card" style="max-width:100%;">
                    <h3>Session Splitting (Post-Processing)</h3>
                    <p>After grouping, sessions are scanned for <strong>prefix events from unrelated devices</strong>
                       that &ldquo;sneaked in&rdquo; within the 30-minute gap. If the session starts with short events
                       followed by a significantly longer event (&ge;3&times; median of preceding events and &ge;10 min),
                       the session is split: prefix events become a separate session, and the long event + rest
                       form the main session. This prevents short noise from contaminating AC classification.</p>
                </div>
            </div>

            <!-- Multi-phase synchronization -->
            <div style="margin-top:20px;">
                <div class="event-card" style="max-width:100%;">
                    <h3>Multi-Phase Synchronization (Central AC Detection)</h3>
                    <p>After per-phase session grouping, each session is tested as a <strong>central AC candidate</strong>
                       (AC-like cycling with consistent magnitude, duration, and gap regularity).
                       Only candidates enter phase synchronization: if sessions on 2-3 different phases overlap
                       within &le;10 minutes, they are merged into a single multi-phase session.</p>
                    <svg viewBox="0 0 600 175" xmlns="http://www.w3.org/2000/svg" style="max-width:600px; display:block; margin:12px auto 0;">
                        <!-- Phase labels -->
                        <text x="20" y="40" fill="#5A90C0" font-size="10" font-weight="bold">w1</text>
                        <text x="20" y="80" fill="#5EB88A" font-size="10" font-weight="bold">w2</text>
                        <text x="20" y="120" fill="#D4956A" font-size="10" font-weight="bold">w3</text>

                        <!-- Timeline lines -->
                        <line x1="45" y1="35" x2="420" y2="35" stroke="#E8E4F0" stroke-width="1"/>
                        <line x1="45" y1="75" x2="420" y2="75" stroke="#E8E4F0" stroke-width="1"/>
                        <line x1="45" y1="115" x2="420" y2="115" stroke="#E8E4F0" stroke-width="1"/>

                        <!-- w1 session -->
                        <rect x="80" y="25" width="180" height="20" fill="#5A90C0" fill-opacity="0.2" rx="4" stroke="#5A90C0" stroke-width="1.5"/>
                        <text x="170" y="39" fill="#2A5A7A" font-size="8" text-anchor="middle">14:00 &mdash; 17:00</text>

                        <!-- w2 session (starts 5 min later) -->
                        <rect x="92" y="65" width="175" height="20" fill="#5EB88A" fill-opacity="0.2" rx="4" stroke="#5EB88A" stroke-width="1.5"/>
                        <text x="179" y="79" fill="#3A6A4A" font-size="8" text-anchor="middle">14:05 &mdash; 16:55</text>

                        <!-- w3 session (starts 8 min later) -->
                        <rect x="100" y="105" width="165" height="20" fill="#D4956A" fill-opacity="0.2" rx="4" stroke="#D4956A" stroke-width="1.5"/>
                        <text x="182" y="119" fill="#7A5030" font-size="8" text-anchor="middle">14:08 &mdash; 16:50</text>

                        <!-- Sync bracket -->
                        <line x1="80" y1="22" x2="100" y2="22" stroke="#9090A0" stroke-width="1"/>
                        <text x="90" y="16" fill="#9090A0" font-size="7" text-anchor="middle">&le;10 min</text>

                        <!-- Arrow to result -->
                        <text x="430" y="80" fill="#B0B4D0" font-size="16" font-weight="bold">&#10132;</text>

                        <!-- Result: merged multi-phase session -->
                        <rect x="455" y="30" width="130" height="95" fill="#EEF8F0" rx="8" stroke="#5EB88A" stroke-width="2"/>
                        <text x="520" y="52" fill="#3A6A4A" font-size="9" font-weight="bold" text-anchor="middle">Central AC Session</text>
                        <text x="520" y="70" fill="#3A6A4A" font-size="8" text-anchor="middle">3 phases synchronized</text>
                        <text x="520" y="86" fill="#9090A0" font-size="8" text-anchor="middle">w1: &#10003; &ensp; w2: &#10003; &ensp; w3: &#10003;</text>
                        <text x="520" y="102" fill="#9090A0" font-size="7" text-anchor="middle">start spread: 8 min</text>
                        <text x="520" y="115" fill="#9090A0" font-size="7" text-anchor="middle">magnitude: sum of 3 phases</text>

                        <!-- Bottom label -->
                        <text x="300" y="155" fill="#7D7D92" font-size="8" text-anchor="middle">Sessions starting within &le;10 min of each other on 2-3 phases &rarr; merged into one central AC session</text>
                        <text x="300" y="168" fill="#9090A0" font-size="7" text-anchor="middle">Single-phase sessions consumed by the merge are removed from the per-phase pool</text>
                    </svg>
                </div>
            </div>
        </section>

        <!-- Device Classification -->
        <section id="classification" class="m2-section">
            <h2>Event-Based Device Classification</h2>
            <p style="color:#7D7D92; margin-bottom:15px;">
                Events are classified in <strong>strict priority order</strong>, with each step removing classified events from the pool.
                Boiler identification happens at the <strong>event level</strong> (1 event = 1 session), with a 3-phase simultaneity check
                that can promote boiler-like events to <strong>three_phase_device</strong> (e.g. EV charger).
                AC detection finds <strong>cycling sequences</strong> rather than relying on pre-grouped sessions.
            </p>

            <!-- Priority order diagram -->
            <div class="pipeline-flow" style="margin-bottom:25px;">
                <div class="pipeline-step" style="background:#D47070; min-width:100px;">
                    <div style="font-size:0.7em; opacity:0.8;">Step 1</div>
                    Boiler
                </div>
                <span class="pipeline-arrow">&#10132;</span>
                <div class="pipeline-step" style="background:#6f42c1; min-width:100px;">
                    <div style="font-size:0.7em; opacity:0.8;">Step 1b</div>
                    3-Phase Device
                </div>
                <span class="pipeline-arrow">&#10132;</span>
                <div class="pipeline-step" style="background:#5A90C0; min-width:100px;">
                    <div style="font-size:0.7em; opacity:0.8;">Step 2</div>
                    Central AC
                </div>
                <span class="pipeline-arrow">&#10132;</span>
                <div class="pipeline-step" style="background:#D4956A; min-width:100px;">
                    <div style="font-size:0.7em; opacity:0.8;">Step 2b</div>
                    Regular AC
                </div>
                <span class="pipeline-arrow">&#10132;</span>
                <div class="pipeline-step" style="background:#8890A0; min-width:100px;">
                    <div style="font-size:0.7em; opacity:0.8;">Step 3</div>
                    Unknown
                </div>
            </div>

            <div class="device-grid">
                <!-- Boiler -->
                <div class="device-card">
                    <h3>Boiler / Water Heater</h3>
                    <svg viewBox="0 0 280 120" xmlns="http://www.w3.org/2000/svg">
                        <rect x="25" y="5" width="240" height="95" fill="#F8F9FF" rx="4"/>
                        <line x1="25" y1="25" x2="265" y2="25" stroke="#E0DCF0" stroke-dasharray="4"/>
                        <line x1="25" y1="50" x2="265" y2="50" stroke="#E0DCF0" stroke-dasharray="4"/>
                        <line x1="25" y1="100" x2="265" y2="100" stroke="#B0B0C0" stroke-width="1"/>
                        <line x1="25" y1="5" x2="25" y2="100" stroke="#B0B0C0" stroke-width="1"/>
                        <polyline points="35,80 55,80 60,25 110,25 160,25 210,25 215,80 245,80 260,80"
                                  fill="none" stroke="#D47070" stroke-width="2.5" stroke-linejoin="round"/>
                        <polygon points="60,25 60,80 215,80 215,25" fill="#D47070" fill-opacity="0.1"/>
                        <line x1="60" y1="90" x2="215" y2="90" stroke="#9090A0" stroke-width="1"/>
                        <line x1="60" y1="87" x2="60" y2="93" stroke="#9090A0" stroke-width="1"/>
                        <line x1="215" y1="87" x2="215" y2="93" stroke="#9090A0" stroke-width="1"/>
                        <text x="137" y="112" fill="#9090A0" font-size="8" text-anchor="middle">&ge; 15 min, &ge; 1500W, single phase</text>
                    </svg>
                    <p>Israeli storage water heaters draw 2000-3000W continuously for 15-45 minutes on a single phase.
                       Must pass <strong>all</strong> gates: &le;2 cycles, &ge;15 min avg duration, &ge;1500W magnitude,
                       isolated (no medium events &plusmn;30 min on same phase),
                       no compressor cycling nearby (&plusmn;60 min, &ge;2 cycles &ge;800W &ge;50% of boiler magnitude).
                       In the classify-first architecture, each boiler event is its own session (no grouping).</p>
                </div>

                <!-- 3-Phase Device -->
                <div class="device-card">
                    <h3>3-Phase Device (Charger?)</h3>
                    <svg viewBox="0 0 280 120" xmlns="http://www.w3.org/2000/svg">
                        <rect x="25" y="5" width="240" height="95" fill="#F8F9FF" rx="4"/>
                        <line x1="25" y1="100" x2="265" y2="100" stroke="#B0B0C0" stroke-width="1"/>
                        <line x1="25" y1="5" x2="25" y2="100" stroke="#B0B0C0" stroke-width="1"/>
                        <text x="35" y="30" fill="#5A90C0" font-size="9" font-weight="bold">w1</text>
                        <text x="35" y="55" fill="#5EB88A" font-size="9" font-weight="bold">w2</text>
                        <text x="35" y="80" fill="#D4956A" font-size="9" font-weight="bold">w3</text>
                        <!-- All 3 phases: same long flat block, simultaneous -->
                        <polyline points="55,30 80,30 85,18 210,18 215,30 250,30"
                                  fill="none" stroke="#6f42c1" stroke-width="2" stroke-linejoin="round"/>
                        <polyline points="55,55 82,55 87,43 212,43 217,55 250,55"
                                  fill="none" stroke="#6f42c1" stroke-width="2" stroke-linejoin="round"/>
                        <polyline points="55,80 84,80 89,68 214,68 219,80 250,80"
                                  fill="none" stroke="#6f42c1" stroke-width="2" stroke-linejoin="round"/>
                        <!-- Sync lines -->
                        <line x1="86" y1="18" x2="89" y2="68" stroke="#6f42c1" stroke-width="0.8" stroke-dasharray="3"/>
                        <line x1="213" y1="18" x2="216" y2="68" stroke="#6f42c1" stroke-width="0.8" stroke-dasharray="3"/>
                        <text x="145" y="112" fill="#9090A0" font-size="8" text-anchor="middle">simultaneous on 2-3 phases, flat block</text>
                    </svg>
                    <p>Detected during boiler classification: when a boiler-like event (&ge;15 min, &ge;1500W) has
                       <strong>similar events on 2+ other phases</strong> starting within &plusmn;10 minutes with magnitude &ge;50%,
                       it's promoted to <code>three_phase_device</code> instead of boiler. Typical cause: EV charger, 3-phase
                       water heater, or industrial equipment. Unlike boilers (single-phase), these draw balanced power across phases.</p>
                </div>

                <!-- Central AC -->
                <div class="device-card">
                    <h3>Central AC</h3>
                    <svg viewBox="0 0 280 120" xmlns="http://www.w3.org/2000/svg">
                        <rect x="25" y="5" width="240" height="95" fill="#F8F9FF" rx="4"/>
                        <line x1="25" y1="100" x2="265" y2="100" stroke="#B0B0C0" stroke-width="1"/>
                        <line x1="25" y1="5" x2="25" y2="100" stroke="#B0B0C0" stroke-width="1"/>
                        <text x="35" y="30" fill="#5A90C0" font-size="9" font-weight="bold">w1</text>
                        <text x="35" y="55" fill="#5EB88A" font-size="9" font-weight="bold">w2</text>
                        <text x="35" y="80" fill="#D4956A" font-size="9" font-weight="bold">w3</text>
                        <polyline points="55,30 80,30 90,18 150,18 200,18 210,30 250,30"
                                  fill="none" stroke="#5A90C0" stroke-width="2" stroke-linejoin="round"/>
                        <polyline points="55,55 85,55 95,43 155,43 205,43 215,55 250,55"
                                  fill="none" stroke="#5EB88A" stroke-width="2" stroke-linejoin="round"/>
                        <polyline points="55,80 82,80 92,68 152,68 202,68 212,80 250,80"
                                  fill="none" stroke="#D4956A" stroke-width="2" stroke-linejoin="round"/>
                        <line x1="90" y1="18" x2="92" y2="68" stroke="#B0B0C0" stroke-width="0.8" stroke-dasharray="3"/>
                        <line x1="210" y1="18" x2="212" y2="68" stroke="#B0B0C0" stroke-width="0.8" stroke-dasharray="3"/>
                        <text x="145" y="112" fill="#9090A0" font-size="8" text-anchor="middle">synchronized across 2-3 phases (&le;10 min)</text>
                    </svg>
                    <p>Ducted or multi-split AC systems operate across 2-3 electrical phases. Each candidate session
                       must first pass an <strong>AC-candidate pre-filter</strong>: &ge;800W, &ge;4 cycles, majority in 3-30 min range,
                       magnitude CV &le;30%, duration CV &le;40%, gap CV &le;50%.
                       Only sessions passing this filter enter phase synchronization (&le;10 min overlap).
                       Applied only to sessions not already classified as boiler.</p>
                </div>

                <!-- Regular AC -->
                <div class="device-card">
                    <h3>Regular AC</h3>
                    <svg viewBox="0 0 280 120" xmlns="http://www.w3.org/2000/svg">
                        <rect x="25" y="5" width="240" height="95" fill="#F8F9FF" rx="4"/>
                        <line x1="25" y1="25" x2="265" y2="25" stroke="#E0DCF0" stroke-dasharray="4"/>
                        <line x1="25" y1="50" x2="265" y2="50" stroke="#E0DCF0" stroke-dasharray="4"/>
                        <line x1="25" y1="100" x2="265" y2="100" stroke="#B0B0C0" stroke-width="1"/>
                        <line x1="25" y1="5" x2="25" y2="100" stroke="#B0B0C0" stroke-width="1"/>
                        <polyline points="35,75 45,75 50,30 75,30 80,75 95,75 100,30 125,30 130,75 145,75 150,30 175,30 180,75 195,75 200,30 225,30 230,75 260,75"
                                  fill="none" stroke="#D4956A" stroke-width="2" stroke-linejoin="round"/>
                        <text x="65" y="112" fill="#9090A0" font-size="7" text-anchor="middle">cycle 1</text>
                        <text x="115" y="112" fill="#9090A0" font-size="7" text-anchor="middle">cycle 2</text>
                        <text x="165" y="112" fill="#9090A0" font-size="7" text-anchor="middle">cycle 3</text>
                        <text x="215" y="112" fill="#9090A0" font-size="7" text-anchor="middle">cycle 4</text>
                    </svg>
                    <p>Wall-mounted split AC running on a single phase. Compressor cycles on/off to maintain temperature.
                       Requires <strong>all</strong>: &ge;800W, &ge;4 total cycles (first cycle &ge;15 min, following &ge;3 min each),
                       magnitude CV &le;20%. When overall CV fails (multi-iteration mixing inflates magnitudes),
                       falls back to checking each iteration independently &mdash; if any iteration with &ge;4 events has CV &le;20%, accepted.
                       The first long cycle represents initial room cooling, followed by shorter maintenance cycles.</p>
                </div>
            </div>

            <!-- Phase Exclusivity + Unclassified — like M1's "Why iterative peeling helps" -->
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:25px;">
                <div class="event-card" style="border-color:#D47070; border-width:1.5px;">
                    <h3 style="color:#D47070;">Boiler Phase Exclusivity</h3>
                    <p>A household has <strong>one</strong> boiler on <strong>one</strong> phase. If boiler sessions are detected on
                       multiple phases, only the <strong>dominant phase</strong> (most sessions) is kept. Sessions on other phases
                       are demoted to &ldquo;unknown&rdquo; with the reason: <em>&ldquo;Boiler-like but on non-dominant phase&rdquo;</em>.</p>
                    <svg viewBox="0 0 340 100" xmlns="http://www.w3.org/2000/svg" style="max-width:340px; margin-top:8px;">
                        <!-- Before -->
                        <rect x="5" y="5" width="140" height="85" fill="#F8F9FF" rx="4" stroke="#E8E4F0"/>
                        <text x="75" y="20" fill="#7D7D92" font-size="7" font-weight="bold" text-anchor="middle">Before exclusivity</text>
                        <!-- w1: 10 boiler bars -->
                        <text x="15" y="42" fill="#5A90C0" font-size="7" font-weight="bold">w1</text>
                        <rect x="30" y="33" width="105" height="10" fill="#D47070" fill-opacity="0.25" rx="2" stroke="#D47070" stroke-width="0.5"/>
                        <text x="82" y="41" fill="#D47070" font-size="6" text-anchor="middle">10 sessions</text>
                        <!-- w2: 3 boiler bars -->
                        <text x="15" y="62" fill="#5EB88A" font-size="7" font-weight="bold">w2</text>
                        <rect x="30" y="53" width="35" height="10" fill="#D47070" fill-opacity="0.25" rx="2" stroke="#D47070" stroke-width="0.5"/>
                        <text x="47" y="61" fill="#D47070" font-size="6" text-anchor="middle">3</text>
                        <!-- w3: 0 -->
                        <text x="15" y="82" fill="#D4956A" font-size="7" font-weight="bold">w3</text>
                        <text x="82" y="82" fill="#B0B0C0" font-size="7" text-anchor="middle">0 boiler sessions</text>

                        <!-- Arrow -->
                        <text x="155" y="52" fill="#B0B4D0" font-size="14" font-weight="bold">&#10132;</text>

                        <!-- After -->
                        <rect x="175" y="5" width="160" height="85" fill="#F8F9FF" rx="4" stroke="#E8E4F0"/>
                        <text x="255" y="20" fill="#7D7D92" font-size="7" font-weight="bold" text-anchor="middle">After exclusivity</text>
                        <text x="185" y="42" fill="#5A90C0" font-size="7" font-weight="bold">w1</text>
                        <rect x="200" y="33" width="105" height="10" fill="#D47070" fill-opacity="0.25" rx="2" stroke="#5EB88A" stroke-width="1"/>
                        <text x="252" y="41" fill="#5EB88A" font-size="6" text-anchor="middle">&#10003; 10 boiler (dominant)</text>
                        <text x="185" y="62" fill="#5EB88A" font-size="7" font-weight="bold">w2</text>
                        <rect x="200" y="53" width="35" height="10" fill="#8890A0" fill-opacity="0.2" rx="2" stroke="#8890A0" stroke-width="1"/>
                        <text x="270" y="61" fill="#8890A0" font-size="6">3 &rarr; unknown</text>
                    </svg>
                </div>

                <div class="event-card" style="border-color:#8890A0; border-width:1.5px;">
                    <h3 style="color:#8890A0;">Unclassified Sessions</h3>
                    <p>Sessions that don't match any device criteria end up as &ldquo;unknown&rdquo;. This is <strong>not necessarily
                       an error</strong> &mdash; many legitimate devices fall here:</p>
                    <div style="margin-top:10px; font-size:0.85em; color:#5D5D72;">
                        <div style="display:flex; align-items:center; gap:6px; margin:5px 0;">
                            <span style="display:inline-block; width:8px; height:8px; background:#8890A0; border-radius:50%;"></span>
                            <span><strong>Too short</strong> (&lt;15 min) or too few cycles (&lt;4) for AC</span>
                        </div>
                        <div style="display:flex; align-items:center; gap:6px; margin:5px 0;">
                            <span style="display:inline-block; width:8px; height:8px; background:#8890A0; border-radius:50%;"></span>
                            <span><strong>Too low magnitude</strong> (&lt;800W) for any known device</span>
                        </div>
                        <div style="display:flex; align-items:center; gap:6px; margin:5px 0;">
                            <span style="display:inline-block; width:8px; height:8px; background:#8890A0; border-radius:50%;"></span>
                            <span><strong>Inconsistent cycling</strong> (CV &gt;20% &mdash; different devices at similar power)</span>
                        </div>
                        <div style="display:flex; align-items:center; gap:6px; margin:5px 0;">
                            <span style="display:inline-block; width:8px; height:8px; background:#D47070; border-radius:50%;"></span>
                            <span><strong>Demoted boilers</strong> on non-dominant phase</span>
                        </div>
                        <div style="display:flex; align-items:center; gap:6px; margin:5px 0;">
                            <span style="display:inline-block; width:8px; height:8px; background:#8890A0; border-radius:50%;"></span>
                            <span><strong>Real small devices</strong>: oven, kettle, washing machine, electric heater</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Confidence Scoring -->
        <section id="confidence" class="m2-section">
            <h2>Confidence Scoring</h2>
            <p style="color:#7D7D92; margin-bottom:15px;">
                Every classified session receives a <strong>confidence score (0&ndash;1)</strong> with a per-factor breakdown.
                Each factor is mapped through <code>_linear_score(value, low, high)</code>: a value at <code>low</code> scores 0.5,
                a value at <code>high</code> scores 1.0, and values in between are linearly interpolated.
                The overall confidence is the <strong>mean</strong> of all factors.
            </p>

            <!-- Linear score visualization -->
            <div style="margin-bottom:20px;">
                <svg viewBox="0 0 500 70" xmlns="http://www.w3.org/2000/svg" style="width:100%; max-width:500px; display:block; margin:0 auto;">
                    <!-- Scale bar -->
                    <defs>
                        <linearGradient id="confGrad" x1="0" y1="0" x2="1" y2="0">
                            <stop offset="0%" stop-color="#F5D8D8"/>
                            <stop offset="50%" stop-color="#F5ECD5"/>
                            <stop offset="100%" stop-color="#D8F0E0"/>
                        </linearGradient>
                    </defs>
                    <rect x="50" y="15" width="400" height="20" fill="url(#confGrad)" rx="4" stroke="#B0B0C0" stroke-width="0.5"/>

                    <!-- Markers -->
                    <line x1="50" y1="15" x2="50" y2="45" stroke="#D47070" stroke-width="2"/>
                    <text x="50" y="55" fill="#D47070" font-size="8" text-anchor="middle" font-weight="bold">0.0</text>

                    <line x1="250" y1="15" x2="250" y2="45" stroke="#6A5A2A" stroke-width="2"/>
                    <text x="250" y="55" fill="#6A5A2A" font-size="8" text-anchor="middle" font-weight="bold">0.5 (low)</text>
                    <text x="250" y="64" fill="#9090A0" font-size="7" text-anchor="middle">minimum threshold</text>

                    <line x1="450" y1="15" x2="450" y2="45" stroke="#5EB88A" stroke-width="2"/>
                    <text x="450" y="55" fill="#5EB88A" font-size="8" text-anchor="middle" font-weight="bold">1.0 (high)</text>
                    <text x="450" y="64" fill="#9090A0" font-size="7" text-anchor="middle">ideal value</text>

                    <!-- Example dot -->
                    <circle cx="370" cy="25" r="5" fill="#3A6A4A" stroke="white" stroke-width="1.5"/>
                    <text x="370" y="10" fill="#3A6A4A" font-size="7" text-anchor="middle">0.80</text>
                </svg>
            </div>

            <!-- Confidence factors per device type -->
            <div class="device-grid">
                <!-- Boiler confidence -->
                <div class="device-card" style="text-align:left;">
                    <h3 style="color:#D47070; text-align:center;">Boiler Factors</h3>
                    <table style="width:100%; font-size:0.85em; border-collapse:collapse; margin-top:8px;">
                        <tr style="border-bottom:1px solid #E8E4F0;">
                            <td style="padding:6px 4px; font-weight:600;">duration</td>
                            <td style="padding:6px 4px; color:#7D7D92;">15 min &rarr; 0.5</td>
                            <td style="padding:6px 4px; color:#7D7D92;">30 min &rarr; 1.0</td>
                        </tr>
                        <tr style="border-bottom:1px solid #E8E4F0;">
                            <td style="padding:6px 4px; font-weight:600;">magnitude</td>
                            <td style="padding:6px 4px; color:#7D7D92;">1500W &rarr; 0.5</td>
                            <td style="padding:6px 4px; color:#7D7D92;">3000W &rarr; 1.0</td>
                        </tr>
                        <tr style="border-bottom:1px solid #E8E4F0;">
                            <td style="padding:6px 4px; font-weight:600;">cycle_count</td>
                            <td style="padding:6px 4px; color:#7D7D92;" colspan="2">1 event = 1.0, 2 events = 0.6</td>
                        </tr>
                        <tr>
                            <td style="padding:6px 4px; font-weight:600;">isolation</td>
                            <td style="padding:6px 4px; color:#7D7D92;">0 min &rarr; 0.5</td>
                            <td style="padding:6px 4px; color:#7D7D92;">30 min &rarr; 1.0</td>
                        </tr>
                    </table>
                    <p style="margin-top:8px; font-size:0.8em; color:#9090A0; text-align:center;">
                        confidence = mean(duration, magnitude, cycle_count, isolation)
                    </p>
                </div>

                <!-- 3-Phase Device confidence -->
                <div class="device-card" style="text-align:left;">
                    <h3 style="color:#6f42c1; text-align:center;">3-Phase Device Factors</h3>
                    <table style="width:100%; font-size:0.85em; border-collapse:collapse; margin-top:8px;">
                        <tr style="border-bottom:1px solid #E8E4F0;">
                            <td style="padding:6px 4px; font-weight:600;">phase_count</td>
                            <td style="padding:6px 4px; color:#7D7D92;" colspan="2">2 other phases = 0.7, 3 other phases = 1.0</td>
                        </tr>
                        <tr style="border-bottom:1px solid #E8E4F0;">
                            <td style="padding:6px 4px; font-weight:600;">sync_quality</td>
                            <td style="padding:6px 4px; color:#7D7D92;">10 min spread &rarr; 0.5</td>
                            <td style="padding:6px 4px; color:#7D7D92;">0 min &rarr; 1.0</td>
                        </tr>
                        <tr style="border-bottom:1px solid #E8E4F0;">
                            <td style="padding:6px 4px; font-weight:600;">mag_balance</td>
                            <td style="padding:6px 4px; color:#7D7D92;">CV &ge;0.5 &rarr; 0.5</td>
                            <td style="padding:6px 4px; color:#7D7D92;">CV = 0 &rarr; 1.0</td>
                        </tr>
                        <tr>
                            <td style="padding:6px 4px; font-weight:600;">duration</td>
                            <td style="padding:6px 4px; color:#7D7D92;">15 min &rarr; 0.5</td>
                            <td style="padding:6px 4px; color:#7D7D92;">30 min &rarr; 1.0</td>
                        </tr>
                    </table>
                    <p style="margin-top:8px; font-size:0.8em; color:#9090A0; text-align:center;">
                        confidence = mean(phase_count, sync_quality, mag_balance, duration)
                    </p>
                </div>

                <!-- Central AC confidence -->
                <div class="device-card" style="text-align:left;">
                    <h3 style="color:#5A90C0; text-align:center;">Central AC Factors</h3>
                    <table style="width:100%; font-size:0.85em; border-collapse:collapse; margin-top:8px;">
                        <tr style="border-bottom:1px solid #E8E4F0;">
                            <td style="padding:6px 4px; font-weight:600;">phase_count</td>
                            <td style="padding:6px 4px; color:#7D7D92;" colspan="2">2 phases = 0.7, 3 phases = 1.0</td>
                        </tr>
                        <tr style="border-bottom:1px solid #E8E4F0;">
                            <td style="padding:6px 4px; font-weight:600;">sync_quality</td>
                            <td style="padding:6px 4px; color:#7D7D92;">10 min spread &rarr; 0.5</td>
                            <td style="padding:6px 4px; color:#7D7D92;">0 min &rarr; 1.0</td>
                        </tr>
                        <tr>
                            <td style="padding:6px 4px; font-weight:600;">mag_balance</td>
                            <td style="padding:6px 4px; color:#7D7D92;">CV &ge;0.5 &rarr; 0.5</td>
                            <td style="padding:6px 4px; color:#7D7D92;">CV = 0 &rarr; 1.0</td>
                        </tr>
                    </table>
                    <p style="margin-top:8px; font-size:0.8em; color:#9090A0; text-align:center;">
                        confidence = mean(phase_count, sync_quality, mag_balance)
                    </p>
                </div>

                <!-- Regular AC confidence -->
                <div class="device-card" style="text-align:left;">
                    <h3 style="color:#D4956A; text-align:center;">Regular AC Factors</h3>
                    <table style="width:100%; font-size:0.85em; border-collapse:collapse; margin-top:8px;">
                        <tr style="border-bottom:1px solid #E8E4F0;">
                            <td style="padding:6px 4px; font-weight:600;">cycle_count</td>
                            <td style="padding:6px 4px; color:#7D7D92;">4 &rarr; 0.5</td>
                            <td style="padding:6px 4px; color:#7D7D92;">10+ &rarr; 1.0</td>
                        </tr>
                        <tr style="border-bottom:1px solid #E8E4F0;">
                            <td style="padding:6px 4px; font-weight:600;">magnitude_cv</td>
                            <td style="padding:6px 4px; color:#7D7D92;">0.20 &rarr; 0.5</td>
                            <td style="padding:6px 4px; color:#7D7D92;">0.05 &rarr; 1.0</td>
                        </tr>
                        <tr style="border-bottom:1px solid #E8E4F0;">
                            <td style="padding:6px 4px; font-weight:600;">initial_duration</td>
                            <td style="padding:6px 4px; color:#7D7D92;">15 min &rarr; 0.5</td>
                            <td style="padding:6px 4px; color:#7D7D92;">30 min &rarr; 1.0</td>
                        </tr>
                        <tr>
                            <td style="padding:6px 4px; font-weight:600;">magnitude</td>
                            <td style="padding:6px 4px; color:#7D7D92;">800W &rarr; 0.5</td>
                            <td style="padding:6px 4px; color:#7D7D92;">1600W &rarr; 1.0</td>
                        </tr>
                    </table>
                    <p style="margin-top:8px; font-size:0.8em; color:#9090A0; text-align:center;">
                        confidence = mean(cycle_count, magnitude_cv, initial_duration, magnitude)
                    </p>
                </div>
            </div>

            <!-- Confidence tiers -->
            <div style="margin-top:20px;">
                <h3>Confidence Tiers</h3>
                <div style="display:flex; gap:15px; margin-top:10px;">
                    <div style="flex:1; padding:14px; background:#D8F0E0; border-radius:8px; text-align:center; border:1px solid #C0D8C0;">
                        <div style="font-size:1.5em; font-weight:bold; color:#3A6A4A;">High</div>
                        <div style="color:#3A6A4A; font-size:0.9em;">&ge; 0.80</div>
                        <div style="color:#7D7D92; font-size:0.8em; margin-top:4px;">Strong match &mdash; device type is confident</div>
                    </div>
                    <div style="flex:1; padding:14px; background:#F5ECD5; border-radius:8px; text-align:center; border:1px solid #F0E4C8;">
                        <div style="font-size:1.5em; font-weight:bold; color:#6A5A2A;">Medium</div>
                        <div style="color:#6A5A2A; font-size:0.9em;">0.50 &ndash; 0.80</div>
                        <div style="color:#7D7D92; font-size:0.8em; margin-top:4px;">Likely correct but some criteria are borderline</div>
                    </div>
                    <div style="flex:1; padding:14px; background:#F5D8D8; border-radius:8px; text-align:center; border:1px solid #F0C0C0;">
                        <div style="font-size:1.5em; font-weight:bold; color:#6A3030;">Low</div>
                        <div style="color:#6A3030; font-size:0.9em;">&lt; 0.50</div>
                        <div style="color:#7D7D92; font-size:0.8em; margin-top:4px;">Meets minimum rules but characteristics are weak</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Future Directions -->
        <section id="future-directions" style="border-left: 4px solid #9070B4;">
            <h2>Future Directions</h2>
            <p style="color:#7D7D92; margin-bottom:20px;">
                Open research directions for improving the pipeline. These are not implemented yet &mdash;
                they describe observed limitations and potential algorithmic improvements.
            </p>

            <div class="event-grid">
                <!-- Dirty remaining signal -->
                <div class="event-card" style="border-color:#D4956A;">
                    <h3>Incomplete Power Extraction</h3>
                    <p>Even when an AC session is correctly classified (e.g., 17 cycles, 83% confidence),
                       the <strong>remaining signal</strong> still shows cycling. The segmentation extracted
                       the detected events but missed some compressor cycles &mdash; because they fell below
                       the detection threshold, were masked by other devices, or had boundary misalignment.</p>
                    <p style="margin-top:8px; color:#5EB88A; font-size:0.85em;">
                        <strong>Partially addressed (exp013):</strong> Settling extension fixes boundary misalignment
                        by extending event boundaries through settling periods, ensuring steady-state power is correctly tracked.
                        Transient spike clipping prevents over-extraction during transient spikes. Split-OFF merger recovers
                        split device shutdowns that previously failed to match.
                    </p>
                    <p style="margin-top:4px; color:#9090A0; font-size:0.85em;">
                        <strong>Remaining direction:</strong> Adaptive magnitude tracking (follow the signal instead of fixed extraction),
                        and smaller-threshold passes to catch residual cycles.
                    </p>
                </div>

                <!-- Missed compressor cycles -->
                <div class="event-card" style="border-color:#D47070;">
                    <h3>Missing Compressor Cycles</h3>
                    <p>Some AC sessions have fewer detected cycles than expected. Compressor cycles can go
                       undetected when: another device activates simultaneously (masking the ON/OFF diff),
                       the cycle is shorter than 3 minutes (filtered as spike), or the magnitude
                       falls between iteration thresholds.</p>
                    <p style="margin-top:8px; color:#5EB88A; font-size:0.85em;">
                        <strong>Partially addressed (exp013):</strong> Guided cycle recovery uses matched cycles
                        as templates to search the remaining signal at a lower threshold (60% of avg magnitude).
                        Requires &ge;3 existing cycles to establish a template.
                    </p>
                    <p style="margin-top:4px; color:#9090A0; font-size:0.85em;">
                        <strong>Remaining direction:</strong> Use periodicity analysis to infer missing cycles,
                        incorporate unmatched ON events with matching magnitude as partial cycles,
                        or apply frequency-domain analysis (FFT) to detect regular cycling.
                    </p>
                </div>

                <!-- Multi-device overlap -->
                <div class="event-card" style="border-color:#5A90C0;">
                    <h3>Multi-Device Overlap</h3>
                    <p>When two devices operate simultaneously on the same phase (e.g., AC + oven),
                       their signals overlap. The iterative peeling approach handles this partially &mdash;
                       each threshold catches the dominant device &mdash; but residual interference
                       can degrade detection of the smaller device or corrupt the remaining signal.</p>
                    <p style="margin-top:8px; color:#9090A0; font-size:0.85em;">
                        <strong>Direction:</strong> Better source separation during segmentation.
                        Potential approaches: model-based decomposition (fit expected device shapes
                        to the composite signal), inter-iteration consistency checks
                        (verify that removing device A doesn&rsquo;t create artefacts that look like device B),
                        and magnitude refinement after matching (adjust extracted power based on
                        the remaining signal&rsquo;s characteristics).
                    </p>
                </div>

                <!-- Cross-session pattern recognition -->
                <div class="event-card" style="border-color:#5EB88A;">
                    <h3>Cross-Session Pattern Learning</h3>
                    <p>The pipeline currently classifies each session independently. But the same household
                       uses the same devices daily. A compressor that runs every evening with consistent
                       magnitude, cycling period, and phase creates a strong prior for future sessions.</p>
                    <p style="margin-top:8px; color:#9090A0; font-size:0.85em;">
                        <strong>Direction:</strong> Build device &ldquo;profiles&rdquo; from high-confidence
                        sessions and use them to improve detection of similar but weaker sessions.
                        If a household&rsquo;s AC is confirmed at 1500W on w1 with 5-minute cycles,
                        look for that specific pattern in sessions that otherwise have too few cycles
                        to classify independently.
                    </p>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer>
            <p>ElectricPatterns NILM Pipeline &mdash; Hila Khadad</p>
            <p style="margin-top:5px;">
                <a href="https://github.com/hilakhadad/ElectricPatterns">GitHub Repository</a>
            </p>
        </footer>

    </div>

    <!-- Full-screen comparison overlay -->
    <div class="comparison-overlay" id="comparisonOverlay">
        <div class="comparison-toolbar">
            <h2>Segmentator Output &mdash; NaN Imputation Comparison</h2>
            <button class="comparison-close" onclick="closeComparison()">Close &times;</button>
        </div>
        <div class="comparison-labels">
            <div class="label-original">Original (no imputation)</div>
            <div class="label-nan">With NaN Imputation</div>
        </div>
        <div class="comparison-frames">
            <iframe id="frame-original"></iframe>
            <iframe id="frame-nan"></iframe>
        </div>
    </div>

    <script>
    function openComparison() {
        var overlay = document.getElementById('comparisonOverlay');
        overlay.classList.add('active');
        document.getElementById('frame-original').src = 'report.html';
        document.getElementById('frame-nan').src = 'nan_comparison.html';
        document.body.style.overflow = 'hidden';
    }
    function closeComparison() {
        var overlay = document.getElementById('comparisonOverlay');
        overlay.classList.remove('active');
        document.getElementById('frame-original').src = '';
        document.getElementById('frame-nan').src = '';
        document.body.style.overflow = '';
    }

    // Collapsible sections
    document.addEventListener('DOMContentLoaded', function() {
        var sections = document.querySelectorAll('section');
        sections.forEach(function(section) {
            var h2 = section.querySelector(':scope > h2');
            if (!h2) return;

            // Wrap everything after h2 in section-body
            var body = document.createElement('div');
            body.className = 'section-body';
            var sibling = h2.nextSibling;
            while (sibling) {
                var next = sibling.nextSibling;
                body.appendChild(sibling);
                sibling = next;
            }
            section.appendChild(body);

            // Start collapsed
            section.classList.add('collapsed');

            // Toggle on click
            h2.addEventListener('click', function(e) {
                e.preventDefault();
                section.classList.toggle('collapsed');
            });
        });

        // Handle TOC links — expand target section on click
        document.querySelectorAll('.toc a[href^="#"]').forEach(function(link) {
            link.addEventListener('click', function() {
                var id = this.getAttribute('href').substring(1);
                var target = document.getElementById(id);
                if (!target) return;
                // If target is a section, expand it directly
                if (target.tagName === 'SECTION' && target.classList.contains('collapsed')) {
                    target.classList.remove('collapsed');
                } else {
                    // If target is inside a section (e.g. h3 subsection), expand parent section
                    var parentSection = target.closest('section');
                    if (parentSection && parentSection.classList.contains('collapsed')) {
                        parentSection.classList.remove('collapsed');
                    }
                }
            });
        });
    });
    </script>
</body>
</html>
